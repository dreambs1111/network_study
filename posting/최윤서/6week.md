**라우터(Router)는 3계층에서 동작하는 경로를 지정해주는 장비**다. 

라우터에 들어오는 패킷의 목적지 IP 주소를 확인하고 자신이 가진 경로(Route) 정보를 이용해 패킷을 최적의 경로로 포워딩한다. 인터넷을 통해 다양한 서비스를 제공받는 현대 네트워크 환경에서는 인터넷을 연결하기 위한 원격지 통신이 매우 중요하다.

원격지 네트워크와 연결할 때 필수 네트워크 장비이며 네트워크를 구성하는 핵심 장비인 라우터를 알아보자.

+) 3계층에서 동작하는 L3스위치와 라우터의 구분이 크게 없어짐

# 라우터의 동작 방식과 역할

## 1. 경로 지정

라우터의 가장 중요한 역할은 경로 지정이다. 경로 정보를 모아 라우팅 테이블을 만들고 패킷이 라우터로 들어오면 패킷의 도착지 IP 주소를 확인해 경로를 지정하고 패킷을 포워딩한다. 

IP 주소는 네트워크 주소와 호스트 주소로 나뉜 계층 구조를 기반으로 설계되어 로컬 네트워크와 원격지 네트 워크를 구분할 수 있고 네트워크 주소를 기반으로 경로를 찾아갈 수 있다. 라우터는 이 IP 주소를 확인해 원격지에 있는 적절한 경로로 패킷을 포워딩한다.
라우터는 경로를 지정해 패킷을 포워딩하는 역할을 두 가지로 구분해 수행한다. 1)경로 정보를 얻는 역할과 2)얻은 경로 정보를 확인하고 패킷을 포워딩하는 역할이다. 라우터는 자신이 얻은 경로 정보에 포함되는 패킷만 포워딩하므로 정확한 목적지 경로를 얻는 것이 중요하다. 다양한 방법으로 경로 정보를 얻을 수 있는데 IP 주소를 입력하면서 자연스럽게 인접 네트워크 정보를 얻는 방법과 관리자가 직접 경로 정보를 입력하는 방법, 라우터끼리 서로 경로 정보를 자동으로 교환하는 방법이 있다.

## 2. 브로드캐스트 컨트롤

스위치는 패킷의 도착지 주소를 모르면 어딘가에 존재할지 모를 장비와의 통신을 위해 플러딩해 패킷을 모든 포트에 전송한다.  LAN은 크기가 작아 플러딩에 대한 영향이 작고 도착지 네트워크 인터페이스 카드(NIC)에서 자신의 주소와 패킷의 도착지 주소가 다르면 패킷을 버리기 때문에 이런 플러딩 작업은 네트워크에 큰 무리를 주지 않는다.

반면, 라우터는 패킷을 원격지로 보내는 것을 목표로 개발되어 3계층에서 동작하고 분명한 도착지 정보가 있을 때만 통신을 허락한다. 
라우터는 바로 연결되어 있는 네트워크 정보를 제외하고 경로 습득 설정을 하지 않으면 패킷을 포워딩할 수 없다. 라우터의 기본 동작은 멀티캐스트 정보를 습득하지 않고 브로드캐스트 패킷을 전달하지 않는데, 이 기능을 이용해 브로드캐스트가 다른 네트워크로 전파되는 것을 막을 수 있는 것이다. 이 기능을 “**브로드캐스트 컨트롤/멀티캐스트 컨트롤**”이라고 한다. 네트워크에 브로드캐스트가 많이 발생하는 경우, 라우터로 네트워크를 분리하면 브로드캐스트 네트워크를 분할해 네트워크 성능을 높일 수 있다.

## 3. 프로토콜 변환

라우터의 세번째 역할은 서로 다른 프로토콜로 구성된 네트워크를 연결하는 것이다. 과거 네트워크는(현재도 일부) LAN에서 사용하는 프토콜과 WAN에서 사용하는 프로토콜이 다르고 완전히 구분된 공간이었다.  LAN 기술이 WAN 기술 로 변환되어야만 인터넷과 같이 원격지 네트워크와의 통신이 가능했고 이 역할을 라우터가 담당했다.

라우터는 3계층에서 동작하는 장비이므로 3계층 주소 정보를 확인하고 그 정보를 기반으로 동작한다. 라우터에 패킷이 들어오면 2계층까지의 헤더 정보를 벗겨내고 3계층 주소를 확인한 후 2계층 헤더 정보를 새로 만들어 외부로 내보낸다. 그래서 라우터에 들어올 때의 패킷 2계층 헤더 정보와 나갈 때의 패킷 2계층 헤더 정보가 다르다.

# 경로 지정 - 라우팅/스위칭

라우터가 패킷을 처리할 때 두가지를 수행한다

- 경로 정보를 얻어 경로 정보를 정리하는 역할
- 정리된 경로 정보를 기반으로 패킷을 포워딩하는 역할

라우터는 많은 경로 정보를 얻어 최적의 경로 정보인 라우팅 테이블을 유지해야한다.

라우터는 **서브넷 단위**로 라우팅 정보를 습득 후 라우팅 정보를 최적화하기 위해 Summary 작업을 통해 여러 서브넷 정보를 뭉쳐 전달한다. 그리고 라우터에 들어온 패킷의 목적지 주소와 라우터가 가지고 있는 라우팅 테이블 정보가 정확하게 일치하지 않더라도 많은 정보 중 목적지에 가장 유사한 정보를 찾아 패킷을 포워딩한다. 

## 라우팅 동작

출발점부터 도착점까지 모든 경로를 한번에 이동하는 것이 아니다.

인접한 라우터까지만 경로를 지정 후 인접 라우터에서 최적의 경로를 다시 파악해 라우터로 패킷을 포워딩한다. 네트워크를 한 단계씩 뛰어넘는다는 의미로 **홉-바이-홉(Hop-by-Hop)라우팅**이라 부르고 이 때 인접한 라우터를 **넥스트 홉(Next Hop)**이라 부른다

⇒ 라우터는 패킷이 목적지로 가는 전체 경로를 파악하지 않고 최적의 넥스트 홉을 선택해 보내준다.

넥스트 홉을 정할때 일반적으로 세가지 방법을 사용한다.

- 다음 라우터의 IP를 지정하는 방법(넥스트 홉 IP 주소)
- 라우터의 나가는 인터페이스를 지정하는 방법: 상대방 넥스트 홉 라우터의 IP 주소를 몰라도 MAC주소 정보를 알아낼 수 있을 때만 사용
- 라우터의 나가는 인터페이스와 다음 라우터의 IP를 동시에 지정 하는 방법: IP 주소와 인터페이스를 동시에 사용할 땐 VLAN 인터페이스와 같은 논리적인 인터페이스를 사용

## 라우팅 테이블

- 라우터는 출발지와 상관없이 목적지 주소와 라우팅 테이블을 비교해 포워딩 경로를 결정한다.
- 라우팅 테이블을 만들 땐 목적지 주소만 수집한다.
- 패킷이 들어오면 목적지 주소를 확인해 패킷을 넥스트 홉으로 포워딩한다.
- 라우팅 테이블에 저장하는 정보는 다음과 같다.
    - 목적지 주소
    - 넥스트 홉 IP주소, 나가는 로컬 인터페이스(선택 가능)

## 라우팅(라우터가 경로 정보를 얻는 방법)

라우터가 경로를 얻는 방법은 크게 세가지가 있다.

1. 다이렉트 커넥티드
2. 스태틱 라우팅
3. 다이나믹 라우팅

⇒ 이 세가지 방법을 이용해 경로 정보 수집 및 최적 경로를 찾아 라우팅 테이블을 만든다.

### 1. 다이렉트 커넥티드

IP주소를 입력할 때 사용된 IP주소와 서브넷 마스크로 해당 IP 주소가 속한 네트워크 주소 정보를 알 수 있다.  라우터나 PC에서는 이 정보로 해당 네트워크에 대한 라우팅 테이블을 자동으로 만든다. 이러한 경로 정보를 다이렉트 커넥티드(Direct Connected)라 부른다.
해당 경로 정보는 인터페이스에 IP를 설정하면 자동 생성되는 정보이기에 정보를 강제로 지울 수 없고 해당 네트워크 설정을 삭제하거나 해당 네트워크 인터페이스가 비활성화되어야만 자동으로 사라진다.

### 2. 스태틱 라우팅

관리자가 목적지 네트워크와 넥스트 홉을 라우터에 직접 지정해 경로 정보를 입력하는 것을 스태틱 라우팅(Static Routing)이라 한다. 이 정보는 연결된 인터페이스 정보가 삭제되거나 비활성화되면 연관된 스태틱 라우팅 정보가 자동 삭제된다.
다만, 물리 인터페이스가 아닌 논리 인터페이스는 물리 인터페이스가 비활성화 되더라도 함께 비활성화되지 않는 경우도 있어 라우팅 테이블에서 사라지지 않을 수 있다.

### 3. 다이나믹 라우팅

스태틱 라우팅 방법은 관리자가 직접 작성을 해줄 수 있기에 직관적으로 관리가 가능하다. 하지만 변화가 크거나 규모가 큰 네트워크일 경우 스태틱 라우팅으로 관리하기는 몹시 힘들다. 스태틱 라우팅은 라우터 너머 다른 라우터의 상태 정보를 파악할 수 없기에 라우터 사이의 회선이나 장애가 발생하면 장애 파악 및 대체 경로로 패킷을 전송할 수 없다.

다이나믹 라우팅은 이러한 스태틱 라우팅의 단점을 보완해준다. 라우터끼리 자신이 알고 있는 경로 정보나 링크 상태 정보를 교환해 전체 네트워크 정보를 학습한다. 주기적으로 또는 상태 정보가 변경될 때 라우터끼리 경로 정보가 교환되기에 위와같이 특정 경로가 장애가 생겨 경로 정보가 사라지게 되더라도 이 상황을 인지해 대체 경로로 패킷을 포워딩할 수 있게 된다.

이처럼 관리자의 개입없이도 자동으로 라우터끼리 정보를 교환해 라우팅 테이블을 갱신하고 장애발생 대처가 가능하기 때문에 대부분의 네트워크에서 다이나믹 라우팅이 사용된다.

## 스위칭(라우터가 경로를 지정하는 방법)

**스위칭**은 **3계층 장비인 라우터가 패킷 경로를 지정해 보내는 작업**을 일컫는 말이다.

패킷을 최적 경로로 포워딩할때도 고려할 부분이 많은데, 들어온 패킷의 목적지가 라우팅 테이블에 있는 정보와 완벽히 일치하지 않은 경우가 생기기 때문이다.

이 스위칭 과정은 라우터에 부하가 많은 작업이다. 정확한 정보를 매치하는 경우에는 단순하게 처리가 가능하지만, 비슷한 경로를 찾는건 유사성 비교 작업을 해야 하기 때문에 더 많은 리소스를 소모한다. 그래서 라우터는 이렇게 부하가 많은 작업의 반복 작업을 줄여주는 기술을 채용하고있다.

## 캐싱

한 번 스위칭 작업을 수행했다면 수행 정보를 캐시에 저장하고 뒤에 들어오는 패킷은 라우팅 테이블을 확인하기전에 캐시를 먼저 확인한다.
이 방식이 효과적인 이유는 패킷 네트워크에서 데이터를 보내기 위해 출발지 IP, 도착지 IP, 포트 번호가 모두 동일한 곳으로 여러 패킷이 연속적으로 보내지기 때문이다. 즉, 같은 곳으로 여러 데이터가 들어갈때마다 최적 경로를 찾는 작업을 다시 수행하는것은 비효율적이기이 캐시를 통해 이를 해결한다.
그럼 캐시는 어느 수준까지할까?
단순히 목적지 IP만 캐시할수도 있고 출발지와 목적지 IP를 모두 캐시할수도 있고, 심지어 포트 번호 정보까지 포함해 플로를 모두 저장하거나 넥스트 홉 L2 정보까지 캐시해 스위칭 시간을 줄일수도 있다.

## 라우팅, 스위칭 우선순위

라우팅 테이블에 저장되는 경로 정보는 최적의 경로들을 모아놓은 핵심 정보다.
일반적인 경로 정보를 모아놓은 토폴로지 테이블에서 좋은 경로 정보의 우선순위는 경로 정보를 받은 방법과 거리를 기준으로 정한다.


**토폴로지 테이블 → 여러 가지 경로 정보 얻음 → 정보를 얻은 소스 기준으로 최적 정보 선정 → 라우팅 테이블**

목적지 네트워크 정보가 동일한 서브넷을 사용하면 정보를 얻은 소스에 따라 가중치를 정하는데 가중치 값은 라우팅 정보의 분류와 마찬가지로 세가지로 나눈다. 

- 내가 갖고 있는 네트워크(다이렉트 커넥티드) - 우선순위 제일 높음
- 내가 경로를 직접 지정한 네트워크(스태틱 라우팅) - 우선순위 중간
- 경로를 전달받은 네트워크(다이나믹 라우팅) - 우선순위 제일 낮음

# 라우팅 설정 방법

위에서 라우터가 경로를 얻을수 있는 방법 3가지(다이렉트 커텍티드, 스태틱 라우팅, 다이나믹 라우팅)에 대해 간단하게 소개를 했었다. 이 3가지 방법에 대해 조금 더 자세히 라우팅 우선순위와 각각의 라우팅 설정 방법에 대해 알아보자.

## 1. 다이렉트 커넥티드
- 라우터나 PC에 IP주소, 서브넷 마스크를 입력하면 다이렉트 커넥티드 라우팅 테이블이 생성된다.
- 목적지가 다이렉트 커넥티드라면 라우터는 L2(*ARP 요청을 직접 보내는*)으로 목적지에 도달한다.
- 외부 네트워크와 통신하려면 다이렉트 커넥티드 외에 스태틱 라우팅이나 다이나믹 라우팅에서 얻은 원격지 네트워크에 대한 적절한 라우팅 정보가 필요하다.
- 반대로 외부 네트워크 주소가 있더라도 다이렉트 커넥티드 정보가 잘못되면 통신이 불가능하다. 외부 네트워크로 나가는 첫 번쨰 길목이 다이렉트 커넥티드이기 때문이다.

## 2. 스태틱 라우팅

- 원격지 네트워크와 통신하기위해 관리자가 직접 라우터에 연결되지않은 원격지 네트워크 정보를 입력하는 것을 스태틱 라우팅이라 한다.
- 다이렉트 커넥티드 다음으로 우선순위가 높다.

### 디폴트 라우팅

네트워크의 규모가 커지거나 인터넷 연결을 해야하는 경우에 라우팅을 스태틱 라우팅으로 처리할 수 없다. 이 경우 스태틱 라우팅을 확장한 디폴트 라우팅을 사용한다.

목적지 주소의 서브넷 마스크가 모두 0인 스태틱 라우팅을 **디폴트 라우팅**이라고 한다. 

- 서브넷 마스크를 이용해 네트워크를 뽑아내는 2진수 and 연산을 사용하는데 서브넷 마스크 1은 체크, 0은 ip 주소와 상관없이 연산 결과가 모두 0이므로 체크하지 않았다는 의미다
- 모든 네트워크 정보를 체크하지 않는다 =  모든 네트워크, 라는 의미이므로 디폴트 라우팅은 이 점을 이용했다.
- 현재 인터넷으로 향하는 경로나 자신에게 경로 정보가 없는 경우 마지막 대체 경로로 디폴트 라우팅을 사용한다. 디폴트 라우팅과 디폴트 게이트웨이는 같은 의미로, 디폴트 게이트웨이를 설정하면 서버의 라우팅 테이블에 디폴트 라우팅이 생성된다.

## 3. 다이나믹 라우팅

라우터끼리 정보를 교환해 경로 정보를 최신으로 유지할 수 있는 다이나믹 라우터는 RIP, OSPF, IS-IS IGRP, EIGRP, BGP같은 다양한 라우팅 프로토콜이 있는데 최근에는 OSPF와 BGP프로토콜이 주로 사용된다.

### 역할에 따른 분류

일반적으로 라우팅 프로토콜은 유니캐스트 라우팅 프로토콜을 말한다. 보통 역할과 동작 원리에 따라 구분한다. 

인터넷에는 AS(Autonomous System)라는 율 시스템이 있는데 SKT, KT, LGU+같은 인터넷 사업자가 한 개 이상의 AS를 운영한다. AS내부에서 사용하는 라우팅 프로토콜을 IGP(Interio Gateway Protocol)라고 하고 AS간 통신에 사용하는 라우팅 프로토콜을 EGP(Exterior Gateway Protocol)이라 한다.

- IGP: AS 내에서 사용하는 라우팅 프로토콜
- EGP: AS간 통신에 사용하는 라우팅 프로토콜

### 동작에 따른 분류

IGP 라우팅 프로토콜은 동작 원리에 따라 크게 디스턴스 벡터와 링크 스테이트로 나뉜다.

- **디스턴스 벡터 :** 인접한 라우터에서 경로 정보를 습득하는 라우팅 프로토콜
    - RIP, BGP가 있다.
    - 인접하지 않은 라우터의 정보는 인접 라우터를 통해 간접적으로 한 단계 건너 받는다.
    - 이미 계산이 된 라우팅 테이블을 전달받기에 라우팅 정보 처리에 많은 리소스가 필요 없다.
    - 간단한 네트워크를 구축하는데 많이 사용되었다.
    - 멀리 떨어진 라우터의 경로정보를 얻는데 많은 라우터를 거쳐야 하기에 모든 라우터 정보가 동기화 하는데 오래 걸린다. 네트워크 변경이 발생하면 정확한 정보 파악에 오랜 시간이 걸릴 수 있다.
- **링크 스테이트:** 라우터에 연결된 링크 상태를 서로 교환하고 각 네트워크 맵을 그리는 라우팅 프로토콜
    - 직접적인 상태 정보를 받아 볼 수 있다.
    - 과정: 링크 상태교환으로 정보 수집 → 토폴로지 데이터베이스를 만들어 링크 상태를 저장 → SPF(Shortest Path First)알고리즘으로 최단 경로 트리를 만든다. → 해당 경로 트리를 작성해 라우팅 테이블을 만든다.
    - 전체 네트워크의 링크 상태 정보를 받아 각자 처리하기에 전체 네트워크 맵을 그리고 경로 변화를 파악하는데 유리하다.
    - 계산하는 과정에 많은 리소스를 소비한다.