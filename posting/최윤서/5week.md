# 4장: 스위치-2계층 장비

네트워크의 가장 핵심장비인 **스위치**는 2계층 주소인 MAC 주소를 기반으로 동작한다. 스위치가 MAC 주소를 어떻게 이해하고 활용하는지 중점적으로 다뤄보고자 한다.

스위치는 네트워크 중간에서 패킷을 받아 필요한 곳에만 보내주는(MAC 주소를 기반으로 패킷을 전달) 네트워크 중재자 역할을 한다. 스위치는 이 동작 외에도 한 대의 장비에서 논리적으로 네트워크를 분리할 수 있는 VLAN 기능과 네트워크의 루프를 방지하는 스패닝 트리 프로토콜(STP)과 같은 기능을 기본적으로 가지고 있다. 그 밖에 다양한 보안 기능과 모니터링에 필요한 여러 기능이 있다.

**PDU: 각 계층에서 헤더와 데이터를 합친 부분

각 계층마다 이 PDU를 부르는 이름이 달라서 1계층 PDU는 비트(Bits), 2계층 PDU는 프레임(Frame), 3계층은 패킷(Packet), 4계층은 세그먼트(Segment)라 부른다.

애플리케이션에 해당하는 5,6,7계층(애플리케이션, 프레젠테이션, 세션)은 데이터(Data)라고 부른다.

→ 2계층의 PDU 명칭은 프레임이 맞지만, 데이터를 쪼갠 것을 패킷이라고 통칭하기도 한다.

# 스위치 장비 동작

: 패킷을 동시에 여러 장비가 서로 간섭 없이 통신하도록 도와주는 장비가 스위치이다. 스위치를 사용하면 여러 단말이 한꺼번에 통신할 수 있어 통신하기 위해 기다리거나 충돌 때문에 대기하는 문제가 해결되고 네트워크 전체의 통신 효율성이 향상된다. 

스위치는 2계층 주소를 이해하고, MAC 주소 테이블(MAC 주소와 스위치의 인터페이스 정보를 매핑)을 가지고 있기에 통신 시 정확한 위치로 패킷을 전송할 수 있다. 스위치는 전송하려는 패킷의 헤더 안에 있는 2계층 목적지 주소를 확인하고 MAC 주소 테이블에서 해당 주소가 어느 포트에 있는지 인해 해당 패킷을 그 포트로만 전송한다.

- 만약 MAC 주소 테이블에 없는 도착지 주소를 가진 패킷이 스위치로 들어오면 스위치는 전체 포트로 패킷을 전송한다.
- 패킷의 도착지 주소가 테이블에 있으면 해당 주소가 매핑된 포트로만 패킷을 전송하고 다른 포트로는 전송하지 않는다.

스위치 의 이런 동작 방식을 다음 3가지로 정리한다.

1. Flooding
2. Address Learning
3. Forwarding,Filtering

## 1. Flooding

스위치는 부팅 시 네트워크 관련 정보가 존재하지 않는다. 이때 스위치는 네트워크 통신을 중재하는 자신의 역할을 하지 못하고 허브처럼 동작한다. 허브는 패킷이 들어온 포트를 제외하고 모든 포트로 패킷을 전달하는데, **스위치가 허브와 같이 모든 포트로 패킷을 흘리는 동작 방식을 플러딩이라고 한다.**

스위치는 패킷이 들어오면 도착지 MAC 주소를 확인하고 자신의 MAC 주소 테이블에서 해당 MAC 주소가 있는지 확인한다. MAC 주소 테이블에 매칭되는 목적지 MAC 주소 정보가 없으면 모든 포트에 같은 내용의 패킷을 전송하는데, 스위치는 LAN에서 동작하므로 자신이 정보를 갖고 있지 않더라도 어딘가에 장비가 있을 수 있 다고 가정하고 이와 같은 작업을 수행한다.

이러한 플러딩 동작은 스위치의 정상적인 동작이지만, 이런 동작이 많아지면 당연히 스위치의 제 역할을 하지 못한다. 스위치가 제 역할을 하기 위해서 MAC 주소 테이블을 만들어야 하기에, 패킷이 들어올 경우 해당 패킷 정보의 MAC 주소를 토대로 MAC 주소 테이블을 만들어낸다.
## 2. Address Learning

스위치가 패킷의 도착지 MAC 주소를 확인하여 원하는 포트로 포워딩하는 스위치의 동작을 정상적으로 수행하려면 **MAC 주소 테이블을 만들고 유지해야 하는데 이를 어드레스 러닝이라고 한다.**
어드레스 러닝은 패킷의 출발지 MAC 주소 정보를 이용한다.  패킷이 특정 포트에 들어오면 스위치에는 해당 패킷의 출발지 MAC 주소 와 포트 번호를 MAC 주소 테이블에 기록한다. 어드레스 러닝은 출발지의 MAC 주소 정보를 사용하므로, (목적지 MAC 주소 필드에서만 사용하는) 브로드캐스트나 멀티캐스트에 대한 MAC 주소를 학습할 수 없다.

## 3. Forwarding,Filtering

패킷이 스위치에 들어온 경우, 도착지 MAC 주소를 확인하고 자신이 가진 MAC 테이블과 비교해 맞는 정보가 있으면 매치되는 해당 포트로 패킷을 **포워딩**한다. 이때 다른 포트로는 해당 패킷을 보내지 않는 이 동작을 **필터링**이라고 한다. 스위치는 이런 포워딩과 필터링을 통해 목적지로만 패킷이 전달되도록 동작하는데, 이때 포워딩과 필터링 작업이 여러 포트에서 동시에 수행될 수 있다. 통신이 다른 포트에 영향을 미치지 않기 때문이다

스위치는 일반적인 **유니캐스트**에 대해서만 포워딩과 필터링 작업을 수행한다.

BUM 트래픽(브로드캐스트와 언노운 유니 캐스트, 멀티캐스트)는 출발지 MAC 주소로 출발지가 사용되지 않으므로 전달이나 필터링 작업을 하지 않고 모두 플러딩한다. 언노운 유니캐스트 도 MAC 주소 테이블에 없는 주소이므로 브로드캐스트와 동일하게 플러딩 동작한다.
---

# VLAN

스위치에서는 VLAN이라는 가상화 기술을 사용해왔다.

 하나의 물리 스위치에서 여러 개의 네트워크를 나누어 사용할 수 있는 VLAN(Virtual Local Area Network)에 어떤 종류가 있고 특징이 무엇인지, 그 동작 원리를 알아보고자 한다.

## VLAN이란

VLAN은 물리적 배치와 상관없이 LAN을 논리적으로 분할, 구성하는 기술이다. 최근에는 다수의 단말이 네트워크에 연결되므로 네트워크 분할이 중요하다. 과도한 브로드캐스트로 인한 단말들의 성능 저하, 보안 향상을 위한 차단 용도, 서비스 성격에 따른 정책 적용과 같은 이유로 네트워크가 분리되어야 한다.

VLAN을 나누면 하나의 장비를 서로 다른 네트워크를 갖도록 논리적으로 분할한 것이므로 유니캐스트뿐만 아니라 브로드캐스트도 VLAN 간에 통신할 수 없다. VLAN 간의 통신이 필요하다면 서로 다른 네트워크 간의 통신이므로 3계층 장비가 필요하다. 

VLAN을 사용하면 **물리적 구성과 상관없이 네트워크를 분리할 수 있고 물리적으로 다른 층에 있는 단말이 하나의 VLAN을 사용해 동일한 네트워크로 묶을 수 있다.**  이렇게 분리된 단말 간에는 3계층 장비를 통해 통신한다.

## VLAN의 종류와 특징

1. 포트 기반 VLAN
    - 과거에 스위치가 고가의 장비였기에 하나의 스위치를 분할해 여러 네트워크에서 사용하는 것이 VLAN을 사용하는 목적이었다. 이처럼 위치를 논리적으로 분할해 사용하는 목적을 가진 VLAN을 Port Based VLAN(포트기반 VLAN)라고 한다.
    - 현재 대부분의 VLAN이 포트 기반 VLAN이며, 어떤 단말이 접속하던 스위치의 특정 포트에 VLAN 을 할당하면 할당된 VLAN에 속하게 된다.
2. MAC 주소 기반 VLAN
    - 사용자들의 자리 이동이 많아지면서 나온 Mac Based VLAN
    - 스위치의 고정된 포트에 VLAN을 할당하는 게 아니라 스위치의 연결되는 단말의 MAC 주소를 기반으로 VLAN 을 할당한다.
    - 단말에 따라 VLAN 정보가 바뀔 수 있기에 Dynamic VLAN 이라고도 한다.

⇒ 두가지 방식의 큰 차이점을 설명해보자면, 포트 기반 VLAN의 경우에는 하나의 단말을 어떤 포트에 연결하느냐에 따라서 속하는 VLAN이 변경된다는 것이고, MAC 기반 VLAN의 경우에는 어떤 포트에 연결하는지와 상관없이 동일한 VLAN이 할당된다는 점이다.

⇒ 데이터 센터에서의 스위치 VLAN은 포트기반 VLAN이 일반적임. 사용자의 이동성을 요구하는 최근 추세로 MAC 기반 VLAN 구성이 증가하는 추세임

## VLAN 모드(Trunk,Access)동작 방식

: VL N으로 구분된 네트워크에서는 브로드캐스트인 ARP 리퀘스트가 다른 VLAN으로 전달될 수 없으므로 3계층 장비를 이용해 통신해야 한다. 

여러 개의 VLAN이 존재하는 상황에서 스위치를 서로 연결해야 하는 경우에는 각 VLAN끼리 통신하려면 VLAN 개수만큼 포트를 연결해야 한다. VLAN으로 분할된 스위치는 물리적인 별도의 스위치처럼 취급된다.

위 그림처럼 3개의 VLAN이 있기 때문에 스위치를 서로 연결할때도 3개의 포트를 연결해야 한다.

VLAN의 개수가 3개가 아니라 수백개로 늘어나게 된다면, VLAN별로 포트를 연결하는 것만으로 포트의 낭비가 심해지게 된다. 이를 해결하기 위해 VLAN 태그 기능이 생겼다.

**VLAN 태그 기능이란 하나의 포트에 여러 VLAN 을 함께 전송할 수 있게 해주는 기능**이다. **이때의 포트를 Tagged 포트 혹은 Trunk 포트**라고 한다.

각 계층에서 MAC 주소, IP 주소를 통해 특정 장비에게 정확한 패킷을 전달할 수 있듯이 **VLAN ID 필드를 이더넷 프레임 중간에 끼워넣어서** 원하는 VLAN으로 전송하면 수신측에서는 이 VLAN ID를 제거 후 해당하는 VLAN으로 패킷을 보낼 수 있다.

이렇게 VLAN ID 를 추가해서 하나의 태그 포트로 유연하게 네트워크를 디자인할 수 있다.

이런 태그 포트 기능이 스위치에 생기면서 스위치의 패킷 정소에 사용하는 MAC 주소 테이블에도 변화가 생긴다. 다른 VLAN끼리 통신하지 못하도록 (기존  MAC 주소와 Port 정보를 담아뒀던)MAC 테이블에 VLAN 필드가 추가되었다. 즉, **하나의 스위치에서 VLAN 을 이용해 네트워크를 분리하면 VLAN 별로 MAC 주소 테이블이 존재하는 것처럼 동작한다.**

---

# STP

IT 환경에서는 SPoF(Single Point of Failure: 단일 장애점) 로 인한 장애를 피하기 위해 다양한 노력을 한다. SPoF란 하나의 시스템이나 구성 요소에서 고장이 발생했을 때 전체 시스템의 작동이 멈추는 요소를 말하는데, 네트워크에서도 하나의 장비 고장으로 전체 네트워크가 마비되는 것을 막기 위해 이중화, 다중화된 네트워크를 디자인하고 구성한다.

네트워크를 스위치 하나로 구성한다면 그 스위치에 장애가 생겼을 때 전체 네트워크에 장애가 생기고, 두 대 이상의 스위치로 구성한다면 패킷이 네트워크를 따라 계속 전송되어 네트워크를 마비시킬 수 있다. 이런 상황을 네트워크 루프라고 하고, 스위치에서 루프를 예방하기 위한 프로토콜은 어떻게 동작하는지 알아보고자 한다.

## 루프란?

패킷이 특정 도달점에 도착해서 사라지는 것이 아니라 여러 스위치를 순회하면서 계속 루프를 도는 것을 말한다. 이는 불필요한 네트워크 비용낭비로 네트워크 마비를 초래한다. 루프가 발생하는 가장 큰 이유, 브로드캐스트 스톰을 살펴보자.

### 브로드캐스트 스톰

루프 구조로 네트워크가 연결된 상태에서 단말에 브로드캐스트를 발생시키면 스위치는 이 패킷을 패킷이 들어온 포트를 제외한 모든 포트로 플러딩한다. 루프 구조 상태에서는 이 패킷이 계속 돌아가는 것을 브로드캐스트 스톰이라고 한다. 3계층 헤더에는 TTL이라는 패킷 수명을 가지고 있지만, 스위치가 확인하는 2계층에는 이같은 수명을 확인하는 메커니즘이 없어 루프가 발생하면 패킷이 계속해서 돌아 네트워크 대역폭을 차지할 수 있다. 이 브로드캐스트 스톰이 일어나게 되면 네트워크 전체 대역폭을 차지해 스위치와 네트워크에 연결된 단말 간 통신이 불가능한 상태가 된다.

### 스위치 MAC 러닝 중복 문제

루프 구조 상태에서는 브로드캐스트 뿐만 아니라 유니캐스트도 문제를 일으킨다. 같은 패킷이 루프를 돌아 도착지 쪽에서 중복 수신되어 혼란이 일어나기도 하지만 중간에 있는 스위치에서도 MAC 러닝 문제가 발생한다.

1) 스위치는 출발지 MAC 주소를 학습하는데 **직접 전달되는 패킷과 스위치를 돌아 도착지로 들어간 패킷 간의 포트가 달라 MAC 주소를 정상적으로 학습할 수 없다.**

2) 또한, 스위치 MAC 주소 테이블에서는 하나의 MAC 주소에 대해 하나의 포트만 학습할 수 있는데 **동일한 MAC 주소가 여러 포트에서 학습되면 MAC 테이블이 반복 갱신되어서 정상적으로 동작할 수 없다**. 

⇒ 이런 현상을 **MAC Address Flapping** 이라고 한다.

MAC Address Flapping이 일어나면 스위치에서 학습된 주소의 포트가 계속 변경되어 스위치가 정상적으로 동작하지 못하고 패킷을 플러딩한다. 이러한 현상을 예방하기 위해 스위치 설정에 따라 경고 메시지를 관리자에게 알려주거나 수시로 일어나는 플래핑 현상을 학습하지 않도록 자동으로 조치한다.

네트워크에 루프가 생기지 않도록 미리 네트워크에 조치를 하는데, 루프 구성 포트 중 하나의 포트만 셧다운 되어 있어도 루프를 예방할 수 있다. 하지만 이 방법은 바람직하지 않고, 네트워크에서 복잡한 케이블 연결을 이용해 루프를 찾아내는 것이 힘들다.

이렇게 사용자가 개입해 네트워크 장애를 적절히 대응할 수 없으므로 루프를 자동 감지해 포트를 차단하고 장애 때문에 우회로가 없을 때 차단된 포트를 스위치 스스로 다시 풀어주는 **SPT(스패닝 트리 프로토콜)**이 개발되었다.

## STP(Spanning Tree Protocol)란?

STP는 루프를 확인하고 적절히 포트를 사용하지 못하게 만들어 루프를 예방하는 메커니즘이다. STP를 이용해 루프를 예방하려면 전체 스위치가 어떻게 연결되는지 알아야하는데, 이를 알려면 스위치 간에 정보를 전달하는 방법이 필요하다. 이를 위해서 스위치는 **BPDU(Bridge Protocol Data Unit)**라는 프로토콜을 통해 스위치 간에 정보를 전달하고 이렇게 수집된 정보를 이용해 전체 네트워크 트리를 만들어 루프 구간을 확인한다.

BPDU에는 스위치가 가지고 있는 ID와 같은 고유값이 들어가고, 이런 정보들이 스위치 간에 교환되면서 루프 파악이 가능해진다. 이렇게 확인된 루프 지점을 데이터 트래픽이 통과하지 못하도록 차단해 루프를 예방한다.

## 스위치 포트의 상태 및 변경 과정

STP가 동작 중인 스위치에서는 루프를 막기 위해 스위치 포트에 신규 스위치가 연결되면 바로 트래픽이 흐르지 않도록 차단한다. 해당 포트로 트래픽이 흘러도 되는지 확인하기 위해 BPDU를 기다려 학습하고 구조를 파악한 후 트래픽을 흘리거나 루프 구조인 경우, 차단 상태를 유지한다. 차단 상태에서 트래픽이 흐를 때까지 스위치 포트의 상태는 다음과 같이 구분한다.

- Blocking
    - 패킷 데이터를 차단한 상태로 상대방이 보내는 BPDU를 기다리는 단계
    - 총 20초인 Max Age 기간 동안 상대방 스위치에서 BPDU를 받지 못했거나 후순위 BPDU를 받았을 때 포트는 리스닝 상태로 변경된다.
    - BPDU 기본 교환 주기는 2초이고 10번의 BPDU를 기다린다.
- Listening
    - 해당 포트가 전송 상태로 변경되는 것을 결정하고 준비하는 단계
    - 자신의 BPDU 정보를 상대방에게 전송하기 시작
    - 15초 동안 대기
- Learning
    - 해당 포트를 포워딩하기로 결정하고 실제로 패킷 포워딩이 일어날 때 스위치가 동작할 수 있도록 Address Learning 하는 단계
    - 15초 동안 대기
- Forwarding
    - 패킷을 포워딩하는 단계: 정상적인 통신 가능

⇒ 스위치는 루프를 예방하기 위해 방어적으로 동작함. 그래서 새로 연결된 단말이 스위치일 가능성이 있어 BPDU를 일정 시간 이상 기다려 스위치 여부를 파악한다. (스위치가 아니라 일반 단말을 연결하더라도 동일한 시간이 필요하다는 것)

⇒ 대부분 위 그림과 같은 50초 정도의 시간을 거치지만, 다운된 링크가 자신의 인터페이스인 경우 토폴로지가 변했음을 직접 감지할 수 있어 Max Age(20초)를 거치지 않고 리스닝부터 STP 상태 변화가 즉시 이루어져서 30초만에 이루어진다.

⇒ 이처럼 STP가 활성화 되어있을 경우에 루프 방지를 위해 방어적으로 동작하는데, 이로 인해 다양한 장애가 발생하거나 스위치 이상으로 생각되는 경우가 많다. 특히 부팅 시간이 빠른 OS가 DHCP 네트워크에 접속할 때 부팅 단계에서 IP를 요청하지만 스위치 포트가 포워딩 상태가 되지 않아 IP를 정상적으로 할당받지 못하는 경우가 많다.

## STP 동작 방식

스위치 간의 루프를 예방하기 위해 STP는 다음과 같이 동작한다.

1. 하나의 루트 스위치 선정
    1. 전체 네트워크에서 하나의 루트 스위치를 선정
    2. 자신을 전체 네트워크의 대표 스위치로 적은 BPDU를 옆 스위치로 전달
2. 루트가 아닌 스위치 중 하나의 루트 포트를 선정
    1. 루트 브릿지로 가는 경로가 가장 짧은 포트를 루트 포트라고 함. 루트 브릿지에서 보낸 BPDU를 받는 포트임
3. 하나의 세그먼트에 하나의 지정 포트를 선정
    1. 스위치와 스위치가 연결되는 포트는 하나의 지정 포트를 선정함
    2. 스위치 간 연결에서 이미 루트 포트로 선정된 경우 반대쪽이 지정 포트로 선덩되어 양쪽 모두 포워딩 상태가 됨
    3. 스위치 간 연결에서 루트 포트가 없을 경우 한 쪽은 지정포트 한쪽은 대체 포트가 되어 차단 상태가 됨
## 향상된  STP(RSTP,MST)

STP는 루프를 예방하기 위해 같은 네트워크에 속한 모든 스위치까지 BPDU가 전달되는 시간을 고려한다. 앞서 설명한 것과 같이 새로운 스위치가 포워딩 상태가 될 때까지 30~50초가 소요되는데, 이 시간이 적지 않다 보니 TCP  기반 애플리케이션에서 네트워크가 끊겼을 때 STP 장애가 생기면서 통신이 끊길 수 있다. 또한 각 VLAN 별로 STP를 계산하면서 부하가 발생할 수 있는 문제도 있다. 이러한 문제를 개선하기 위해 향상된 STP가 나오게 되었다.

## 1. RSTP

백업 경로를 활성화하는데 시간이 너무 오래 걸리는 문제(30~50초)를 해결하기 위해 RSTP(Rapid Spanning Tree Protocol)이 개발됨. RSTP는 2~3초로 시간이 짧아 일반적인 TCP 기반 애플리케이션이 세션을 유지할 수 있다. 

- 기본적인 구성과 동작 방식은 STP와 같지만 BPDU 메시지 형식이 다양해져(8비트 사용) 여러 가지 상태 메시지를 교환할 수 있다.
- 기존에는 토폴로지 변경시 말단 스위치부터 루트까지 올라갔다가 재연산 후 다시 말단 스위치까지 보내는 과정을 하는데, 모든 스위치까지 전파되는 예비 시간을 고려해야 하기 때문에 정보를 확정하는데 시간이 오래 걸린다. 하지만, **RSTP에서는 토폴로지 변경이 일어난 스위치가 모든 네트워트에 토폴로지 변경을 직접 전파**할 수 있다.
- 실제로 RSTP는 2~3초 안에 장애 복구가 가능해 장애가 발생해 경로가 절체되더라도 애플리케이션 세션이 끊기지 않아서 보다 안정적으로 네트워크를 운영하는데 도움이 된다

## 2. MST

일반 스패닝 트리 프로토콜은 CST(Common Spanning Tree)라고 부른다. VLAN 개수와 상관없이 스패닝 트리 한개만 동작한다. 이 경우에, VLAN이 많더라도 스패닝 트리 한개만 동작해서 스위치의 관리 부하가 적은데, CST는 루프가 생기는 토폴로지에서 한 개의 포트와 회선만 활성화되어 자원을 효율적으로 활용할 수 없다. 또한, VLAN마다 최적의 경로가 다른데, 포트 하나만 사용할 수 있어 멀리 돌아서 통신해야하는 경우가 생기기도 한다.

이 문제를 해결하기 위해 PVST(Per VLAN Spanning Tree)가 개발 되었고, 이로 인해 VLAN마다 다른 스패닝 트리 프로세스가 동작해 VLAN마다 별도의 경로와 트리를 만들 수 있게 되었다. 그로 인해 최적의 경로를 디자인하고 VLAN마다 별도의 블록 포트를 지정해 네트워크 로드를 셰어링하도록 구성할 수 있게 되었다.

(*로드 셰어링: 하나의 물리적인 인터페이스를 논리적으로 나눠 부하를 분산시킴, 분산되는 트래픽의 양이 다름)

하지만 STP 자체가 스위치에 많은 부담을 주는 프로토콜(2초마다 교환)인데 PVST는 모든 VLAN마다 별도의 스패닝 트리를 유지해야 해서 더 많은 부담이 되었다. 이런 CST와 PVST의 단점을 보완하기 위해 MST(Multiple Spanning Tree)가 개발되었다.
MST(Multiple Spanning Tree)의 아이디어는 단순하다. 여러 개의 VLAN을 그룹으로 묶고 그 그룹마다 별도의 스패닝 트리가 동작한다. 이 경우, PVST보다 훨씬 적은 STP 프로세스가 돌게 되 고 PVST의 장점인 로드 셰어링 기능도 함께 사용할 수 있다.