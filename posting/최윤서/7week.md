기존 네트워크 장비는 스위치와 라우터처럼 2계층이나 3계층에서 동작하는 장비를 지칭하는 용어였지만 IP 부족으로 NAT 기술이 등장 하고 보안용 방화벽, 프록시와 같은 장비들이 등장하면서 4계층 이상에서 동작하는 네트워크 장비가 많아지면서 **4계층에서 동작하는 장비도 네트워크 장비에 포함**되었다. 기존 2, 3계층 장비에서 고려하지 않았던 **통신의 방향성이나 순서**와 같은 통신 전반에 대한 관리가 필요해지면서 이런 정보를 **세션 테이블(Session Table)**이라는 공간에 담아 관리한다. **4계층 이상에서 동작하는 네트워크 장비는 이런 세션 테이블을 관리해야 하고 이 정보를 기반으로 동작**한다.
이번 장에서는 4계층 장비의 특징과 종류, 4계층 장비 구성 시의 유의점, 4계층 이상의 애플리케이션 프로토콜을 다루는 확장 장비인 ADC를 다뤄보도록 하겠다.

# 1. 4계층 장비의 특징

4계층 장비는 TCP와 같은 4계층 헤더에 있는 정보를 이해하고 이 정보들을 기반으로 동작한다. 기존 네트워크 장비와 다른 점인 세션 테이블과 그 안에서 관리하는 세션 정보가 가장 중요하다. 그래서 4계층 이상에서 동작하는 **로드 밸런서, 방화벽**과 같은 장비를 ‘**세션 장비**’라고 부르기도 한다.

세션 장비에서 최우선적으로 고려할 요소는 다음과 같다.

- **세션 테이블** : 세션 장비는 세션 테이블 기반으로 운영됨. 세션 정보를 저장, 확인하는 작업 전반에 대한 이해가 필요함. 세션 정보는 세션 테이블에 남아 있는 라이프타임이 존재.
- **Symmetric(대칭) 경로 요구** : Inbound와 Outbound 경로가 일치해야 함.
- **정보 변경(로드 밸런서의 경우)**: IP 주소가 변경되며 확장된 L7 로드 밸런서(ADC)는 애플리케이션 프로토콜 정보도 변경됨.

세션 장비의 이런 요소가 서비스에 영향을 미치므로 네트워크 통신 중간 위치에 세션을 기반으로 동작하는 방화벽, NAT, 로드 밸런서와 같은 장비가 있을 경우, 네트워크 인프라뿐만 아니라 시스템 설계와 애플리케이션 개발에도 세션 장비에 대한 고려가 필요하다. 

# 2. 로드밸런서

서버나 장비의 부하를 분산하기 위해 사용하는 장비를 흔히 **로드 밸런서**라고 부른다. 트래픽을 분배해주는 기능이 있어 4계층 이상에서 동작하고, IP 주소나 4계층 정보, 애플리케이션 정보를 확인, 수정하는 기능이 있다. 

- 가장 많이 쓰이는 분야는 **웹 서버의 부하 분산**이다. 내부 부품을 이중화하거나 용량이 더 큰 부품을 사용하면 가격이 크게 올라가므로 작은 장비 여러 대를 묶어 사용하는 방법을 선호한다. 이런 시스템 확장 방법을 **스케일 아웃** 이라고 함.
- 스케일 아웃을 이용한 확장 방법을 사용하더라도 사용자는 서버 배치와 상관없이 하나의 서비스로 보여야 한다.
- 로드 밸런서가 서비스에 사용되는 대표 IP 주소를 서비스 IP로 갖고 그 밑에 시스템이 늘어나면 로드 밸런서가 각 시스템의 실제 IP로 변경해 요청을 보낸다. 이런 로드 밸런서는 웹, 애플리케이션뿐만 아니라FWLB(FireWall Load Balancing: 방화벽 로드 밸런싱), VPNLB(VPN Load Balancing: VPN 로드 밸런싱)와 같이 다양한 서비스를 위해 사용될 수 있다.

로드 밸런서는 동작하는 계층에 따라 보통 4계층과 7계층으로 나뉜다.
1) **L4 로드 밸런싱**: 일반적인 로드 밸런서가 동작하는 방식이다. TCP, UDP 정보 (특히 포트 넘버)를 기반으로 로드 밸런싱을 수행한다. 최근 로드 밸런서는 L4, L7의 기능을 모두 지원하므로 L4 로드 밸런싱만 제공하는 전용장비는 찾기 힘들지만 장비에서 L7 지원 여부와 상관없이 4계층에 대한 정보로만 분산 처리하는 경우를 L4 로드 밸런싱이라고 한다.
2) **L7 로드 밸런싱**: HTTP, FTP, SMTP와 같은 애플리케이션 프로토콜 정보를 기반으로 로드 밸런싱을 수행한다. HTTP 헤더 정보나 URI와 같은 정보를 기반으로 프로토콜을 이해한 후 부하를 분산할 수 있다. 일반적으로 이런 장비를 ADC(Application Delivery Controller)라고 부르며 프록시(Proxy) 역할을 수행한다. 스퀴드(Squid)나 Nginx에서 수행하는 리버스 프록시(Reverse Proxy)와 유사한 기능을 갖고 있다.

### L4 스위치

- 4계층에서 동작하면서 로드 밸런서 기능이 있는 스위치로, 여러 개의 포트가 존재
- 부하 분산, 성능 최적화, 리다이렉션 기능을 제공
- L4 스위치가 동작하려면 가상 서버, 가상 IP, 리얼 서버, 리얼 IP를 설정해야 한다. 가상 서버와 IP는 사용자가 바라보는 실제 서비스고, 리얼 서버,IP는 실제 서비스를 수행하는 서버이다. L4 스위치가 목적지로 설정된 가상 IP를 리얼 IP로 다시 변경해 보내주는데, 이 과정에서 부하를 어떤 방식으로 분산할지 결정할 수 있다.

### ADC(Application Delivery Controller)

- 애플리케이션 계층에서 동작하는 로드밸런서로, 애플리케이션 프로토콜의 헤더와 내용을 이해하고 동작한다.
- 대부분의 ADC는 4계층에서 애플리케이션 계층까지 로드 밸런싱 기능을 제공하며 페일오버, 리다이렉션 기능도 함꼐 수행한다.
- 캐싱, 압축, 콘텐츠 변환 및 재작성, 인코딩 변환 등이 가능하고 애플리케이션 프로토콜 최적화 기능을 제공한다.

# 3. 방화벽

네트워크 중간에 위치해 해당 장비를 통과하는 트래픽을 사전에 주어진 정책 조건에 맞춰 허용하거나 차단하는 장비이다.

- 일반적으로 네트워크 3,4 계층에서 동작
- 세션을 인지하고 관리하는 엔진을 기반으로 동작하는 장비를 방화벽이라고 함
- 방화벽은 세션 정보를 장비 내부에 저장함
- 패킷이 외부로 나갈 때 세션 정보를 저장하고, 패킷이 들어오거나 나갈 때 저장했던 세션 정보를 먼저 참조해 들어오는 패킷이 외부에서 처음 시작된 것인지 내부 사용자가 외부로 요청한 응답인지 가려냄.

# 4. 4계층 장비를 통과할 때의 유의점(세션 관리)

세션 장비는 일반적인 2, 3계층 네트워크 장비와 달리 세션을 이해하고 세션테이블을 유지한다. 세션 테이블 정보를 이용해 패킷을 변경하거나 애플리케이션 성능을 최적화하고 모안을 강화하기 위해 패킷을 포워드 하거나 드롭 할 수 있다. 이런 기능을 충분히 활용하려면 애플리케이션과 세션 장비 간 세션 정보를 동일하게 유지해주거나 애플리케이션을 제작할 때 네트워크 중간에 있는 세션 장비를 고려해 여러 가지 기능을 추가해줘야 한다.