# 6장: 로드 밸런서/방화벽: 4계층 장비(세션장비)

기존 네트워크 장비는 스위치와 라우터처럼 2계층이나 3계층에서 동작하는 장비를 지칭하는 용어였지만 IP 부족으로 NAT 기술이 등장 하고 보안용 방화벽, 프록시와 같은 장비들이 등장하면서 4계층 이상에서 동작하는 네트워크 장비가 많아지면서 **4계층에서 동작하는 장비도 네트워크 장비에 포함**되었다. 이런 장비는 4계층의 특징 인포트 번호, 시퀀스 번호, ACK 번호에 대해 이해하고자 한다. 기존 2, 3계층 장비에서 고려하지 않았던 통신의 방향성이나 순서와 같은 통신 전반에 대한 관리가 필요하며 이런 정보를 **세션 테이블(Session Table)**이라는 공간에 담아 관리한다. **4계층 이상에서 동작하는 네트워크 장비는 이런 세션 테이블을 관리해야 하고 이 정보를 기반으로 동작**한다.
이번 장에서는 4계층 장비의 특징과 종류, 4계층 장비 구성 시의 유의점,4계층 이상의 애플리케이션 프로토콜을 다루는 확장 장비인 ADC를 다뤄보도록 하겠다.

# 1. 4계층 장비의 특징

4계층 장비는 TCP와 같은 4계층 헤더에 있는 정보를 이해하고 이 정보들을 기반으로 동작한다. 4계층 프로토콜 동작에 대한 깊은 이해 없이 4계층 장비를 2, 3계층 네트워크 장비처럼 설계, 운용하면 여러 가지 문제가 발생합니다. 기존 네트워크 장비와 다른 점을 이해해야 하는데 세션 테이블과 그 안에서 관리하는 세션 정보가 가장 중
요합니다. 그래서 4계층 이상에서 동작하는 **로드 밸런서, 방화벽**과 같은 장비를 ‘**세션 장비**’라고 부르기도 합니다.

세션 장비는 추가로 고려해야 할 특징이 많은데 그 중 최우선적으로 고려할 요소는 다음과 같습니다.

- **세션 테이블** : 세션 장비는 세션 테이블 기반으로 운영됩니다.세션 정보를 저장, 확인하는 작업 전반에 대한 이해가 필요합니다. 세션 정보는 세션 테이블에 남아 있는 라이프타임이 존재합니다. 이 부분에 대한 고려가 필요합니다.
- **Symmetric(대칭) 경로 요구** : Inbound와 Outbound 경로가 일치해야 합니다.
- **정보 변경(로드 밸런서의 경우)**: IP 주소가 변경되며 확장된 L7 로드 밸런서(ADC)는 애플리케이션 프로토콜 정보도 변경됩니다.

세션 장비의 이런 요소가 서비스에 영향을 미치므로 네트워크 통신 중간 위치에 세션을 기반으로 동작하는 방화벽, NAT, 로드 밸런서와 같은 장비가 있을 경우, 네트워크 인프라뿐만 아니라 시스템 설계와 애플리케이션 개발에도 세션 장비에 대한 고려가 필요하다. 

# 2. 로드밸런서

# 3. 방화벽

# 4. 4계층 장비를 통과할 때의 유의점(세션 관리)