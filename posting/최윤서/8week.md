# 7장 : 통신을 도와주는 네트워크 주요 기술

IP 네트워크에는 통신을 도와주고 사용자를 편리하게 해주는 다양한 서비스와 프로토콜이 있다.
사용자가 IP 설정을 하지 않더라도 IP 주소를 자동으로 할당해주는 **1) DHCP**(Dynamic Host Configuration Protocol), 사용자가 복잡한 목적지 IP를 기억하지 않고 쉬운 도메인 이름을 사용하도록 도메인 이름과 IP 주소를 매핑해주는 **2) DNS**(Domain Name System), 사용자가 가장 가까운 지역의 데이터 센터에 접속해 신속한 서비스를 받게 해주는 **3) GSLB**(Global Service Load Balancing), 하나의 IP를 사용해 여러 단말 장비를 포함하는 네트워크를 손쉽게 구축하도록 도와주는 NAT와 같은 다양한 기술들이 사용된다.
중요한 **NAT, DNS, GSLB, DHCP**에 대해 자세히 알아보자.

# NAT / PAT

NAT(Network Address Translation)은 네트워크 주소를 변환하는 기술이다. NAT는 기본적으로 하나의 네트워크 주소에 다른 하나의 네트워크 주소로 변환하는 1:1 변환이 기본이지만, IP 주소가 고갈되는 문제를 해결하기 위해 여러개의 IP를 하나의 IP로 변환하는 기술도 NAT 기술 중 하나이다. 실제 공식용어는 NAPT(Network Address Port Translation), 실무에서는 PAT(Port Address Translation) 이라는 용어를 씀

## 1) NAT/PAT 의 용도와 필요성

- **IPv4 주소 고갈문제의 솔루션으로 NAT가 사용됨**: 외부에 공개해야 하는 서비스는 공인 IP, 공개할 필요가 없는 일반 사용자의 PC나 기타 종단 장비에 대해서는 사설 IP를 사용해 필요한 곳에만 효율적으로 IP를 사용할 수 있게 됨
- **보안을 강화하는데 NAT 기술 사용**: 외부와 통신할때 내부 IP를 다른 IP로 변환해 통신하면 외부에 사내 IP 주소 체계를 숨길 수 있음. 내부 네트워크에서 외부 네트워크로 나가는 방향 통신은 허용하지만 외부에서 시작해 내부로 들어오는 통신은 방어할 수 있음(보안을 쉽게 강화할 수 있다)
- **IP주소 체계가 같은 두 개의 네트워크 간 통신을 가능하게 해줌**: IP 네트워크에서 서로 통신하려면 식별 가능한 유일 IP 주소가 필요하다. 사설 IP 대역이 같은 네트워크와 통신할 가능성이 높은 대외계 네트워크를 연결하기 위해 출발지와 도착지를 한꺼번에 변환하는 “더블 나트(Double NAT)” 기술을 사용함.
- **불필요한 설정 변경을 줄일 수 있음**:  외부에 서비스하던 공인 IP 주소가 변경되므로 DNS 서비스나 NAT를 수행하는 네트워크 장비 설정은 변경해야 하지만 내부 서버나 PC 설정 변경을 최소화 할 수 있어 불필요한 설정 변경을 줄일 수 있음.

⇒ 장점만 있는게 아님. 개발자들이 애플리케이션을 제작할 때 NAT 환경을 항상 고려해야 하는 상황이 됨.

## 2) SNAT와 DNAT

- SNAT: Source NAT - 출발지 주소를 변경하는 NAT
- DNAT: Destination NAT - 목적지 주소를 변경하는 NAT

⇒ SNAT와 DNAT는 트래픽이 출발하는 시작 지점을 기준으로 구분

### SNAT를 사용하는 경우

- SNAT는 사설에서 공인으로 통신할 때 많이 사용공인 IP 주소의 목적지에서 출발지로 다시 응답을 받으려면 출발지 IP 주소 경로가 필요하다.
- 공인 대역에서는 사설 대역으로의 경로를 알 수 없다. 공인 IP의 목적지로 서비스를 요청할 때는 출발지에서 사설 IP를 별도의 공인 IP로 NAT해 서비스를 요청한다. (목적지에서 출발지 IP를 공인 IP로 확인해 다시 응답할 수 있는 경로를 찾을 수 있음)
- 보안상 SNAT 를 사용하는 경우 회사에서 다른 대외사와 통신 시 내부 IP 주소가 아니라 별도의 다른 IP로 전환해 전송한다. 대외에 내부의 실제 IP 주소를 숨길 수 있고 대외사의 사내 IP 대역과 중복될 경우에는 SNAT를 통해 중복되지 않는 다른 IP로 변경해 통신하는 데 사용할 수 있다.
- 로드 밸런서의 구성에 따라 SNAT를 사용하기도 함. 출발지와 목적지 서버가 동일한 대역일 때 로드 밸런서 구성에 따라 트래픽이 로드 밸런서를 거치지 않고 응답할 수 있어서 SNAT를 통해 응답 트래픽이 로드밸런서를 거치게 할 수 있다.

### DNAT를 사용하는 경우

- 로드 밸런서를 사용할 경우 사용자는 서비스 요청을 위해 로드 밸런서에 설정된 서비스 VIP로 서비스를 요청하고, 로드밸런서에서는 서비스 VIP를 로드 밸런싱될 서버 실제 IP로 DNAT해서 내보낸다.
- 사내가 아닌 대외망과의 네트워크 구성에도 DNAT 를 사용사내가 아닌 대외망과의 연동에서는 IP가 중복될 수 있다.
- IP가 중복되지 않더라도 IP 주소가 제각각이므로 신규 대외사와의 연동마다 라우팅을 개별적으로 설정해야한다. 이 경우, 대외망에 NAT 장비를 이용해 대외사의 IP를 특정 IP 대역으로 NAT를 사용한다.

## 3) 동적 NAT와 정적 NAT

출발지와 목적지의 IP를 미리 매핑해 고정해놓은 NAT를 **정적 NAT**라고 한다. 출발지나 목적지 어느 경우든 사전에 정해지지 않고 NAT를 수행할 때 IP를 동적으로 변경하는 것을 **동적 NAT**라고 한다.

동적 NAT는 출발지와 목적지가 모두 정의된 것이 아닌 다수의 IP 풀에서 정해지기 때문에 출발지나 목적지 중 한 곳은 적어도 다수의 IP로 구성 된 IP 풀이나 레인지로 설정되어야 한다. NAT가 필요할 때 IP 풀에서 어떤 IP로 매핑될 것인지 판단해 NAT를 수행하는 시점에 NAT 테이블을 만들어 관리한다. NAT 테이블은 설정된 시간 동안 유지 일정 시간 동안 통신이 없으면 사라지고(NAT 테이블 타임아웃), NAT의 설정은 서비스 흐름을 고려해서 적용한다.

정적 NAT는 출발지와 목적지 매핑 관계가 특정 IP로 사전에 정의 1:1 NAT 라고 부르기도 한다. 서비스 방향에 따라 고려할 필요 없고, 방향성 없이 서비스 흐름을 고려하지 않고 NAT를 설정할 수 있고 타임아웃도 존재하지 않는다.

---

# DNS

숫자로 이루어진 IP 주소(202.179.177.21)보다 도메인 주소([www.naver.com](http://www.naver.com/))를 사용 하는 것이 기억하기 더 쉽고, 서비스 중인 IP 주소가 변경되더라도 도메인 주소를 그대로 유지해 접속 방법 변경 없이 서비스를 그대로 유지할 수 있음.

1. 사용자가 웹 브라우저에 naver.com을 입력하면 DNS 서버에 naver.com의 주소가 무엇인지 질의함
2. DNS 서버는 naver.com의 IP 주소(202.179.177.21)를 사용자에게 알려줌
3. 사용자는 DNS로 응답받은 IP 주소를 이용해 naver.com에 접속함

## DNS 구조와 명명 규칙


도메인은 역트리 구조로 최상위 루트 부터 Top-Level 도메인, Second-Level 도메인, Third-Level 도메인과 같은 하위 레벨로 원하는 주소를 단계적으로 찾아간다. 도메인 주소는 각 계층의 경계를 `.`으로 표시하고 뒤에서 앞으로 해석한다. 

- 루트 도메인은 도메인을 구성하는 최상위 영역이다. DNS 서버는 사용자가 쿼리한 도메인에 대한 값을 직접 갖고 있거나 캐시에 저장된 정보를 이용해 응답한다. 만약 DNS 서버에 해당 도메인 정보가 없으면 루트 도메인을 관리하는 루트 DNS 에 쿼리하게 된다.
- 최상위 도메인인 TLD(Top-Level Domain)는 IANA에서 구분한 6가지 유형으로 구분함

## DNS 동작 방식

도메인을 IP 주소로 변환하려면 DNS 서버에 도메인 쿼리하는 과정을 거쳐야 한다. 

- DNS 서버 없이 로컬에 도메인과 IP 주소를 직접 설정해 사용할 수도 있다. 로컬에서 도메인과 IP 주소를 관리하는 파일 hosts 파일이라고 하고, hosts 파일에 도메인과 IP 주소를 설정해두면 해당 도메인 리스트는 항상 DNS 캐시에 저장된다.
- 도메인을 쿼리하기 전 먼저 로컬에 있는 DNS 캐시 정보를 확인한다. DNS 캐시 정보에 필요한 도메인 정보가 없으면 DNS 서버로 쿼리를 수행한다.
- DNS 는 분산된 데이터베이스로 서로 도와주도록 설계한다.

## 마스터와 슬레이브

DNS 서버는 마스터(Master, Primary) 서버와 슬레이브(Slave, Secondary) 서버로 나눌 수 있다. 마스터 서버가 우선순위가 더 높지 않고 두 서버 모두 도메인 쿼리에 응답하는데, 마스터와 슬레이브는 도메인에 대한 Zone 파일을 직접 관리하는지 여부로 구분한다. 

마스터 서버는 존 파일을 직접 생성해 도메인 관련 정보를 관리하고 슬레이브 서버는 마스터에 만들어진 존 파일을 복제하고, 이 과정을 ‘**영역 전송(Zone Transfer)**’이라고 한다. 마스터 서버는 도메인 영역을 생성하고 레코드를 직접 관리하지만 슬레이브 서버는 마스터 서버에 설정된 도메인이 가진 레코드값을 정기적으로 복제한다.