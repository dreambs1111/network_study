# 부하 분산이란? 부하 분산 방법

서비스의 안정성이나 가용량을 높이기 위해 복잡한 고려 없이 이중화를 손쉽게 구현하도록 로드 밸런서가 많이 사용된다. 로드 밸런서는 다양한 구성 방식과 동작 모드가 있으며 각 방식과 모드에 따라 서비스 흐름이나 패킷 내용이 달라진다. 서비스에 따라 적용해야 하는 구성 방식과 동작 모드가 각각 다르고 고려해야 하는 지점도 다르다.

## 부하 분산

서비스 규모가 커지면 서버 한 대로는 모든 서비스를 수용할 수 없게 된다. 서버 한 대로 서비스를 제공할 수 있는 용량이 충분하더라도 서비스를 단일 서버로 구성하면 해당 서버의 애플리케이션, 운영체제, 하드웨어에 장애가 발생했을 때, 정상적인 서비스를 제공할 수 없다. 서비스 가용성을 높이기 위해 하나의 서비스는 보통 두 대 이상의 서버로 구성하는데 각 서버 IP 주소가 다르므로 사용자가 서비스를 호출할 때는 어떤 IP로 서비스를 요청할지 결정해야 한다. 사용자에 따라 호출하는 서버의 IP가 다르면 특정 서버에 장애가 발생했을 때, 전체 사용자에게 영향을 미치지 않아 장애 범위는 줄어들겠지만 여전히 부분적으로 서비스 장애가 발생한다.

⇒ 이런 문제점을 해결하기 위해 L4나 L7 스위치라는 로드 밸런서(Load Balancer)를 사용한다. 로드 밸런서에는 동일한 서비스를 하는 다수의 서버가 등록되고 사용자로부터 서비스 요청이 오면 로드 밸런서가 받아 사용자별로 다수의 서버에 서비스 요청을 분산시켜 부하를 분산한다. 대규모 서비스 제공을 위해 이런 로드 밸런서는 필수 서비스이다. 로드 밸런서에서는 서비스를 위한 가상 IP(VIP)를 하나 제공하고 사용자는 각 서버의 개별 IP 주소가 아닌 동일한 가상 IP를 통해 각 서버로 접근한다. 이 외에도 로드 밸런서는 각 서버의 서비스 상태를 체크해 서비스가 가능한 서버로만 사용자의 요청을 분산하기에 서버에서 장애가 발생하더라도 기존 요청을 분산하여 다른 서버에서 서비스를 제공할 수 있다.

---

## 로드 밸런서 구성 방식

### 1. 원암 구성

![스크린샷 2022-01-15 오후 4.21.47.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/306aa00c-a771-4c26-97c8-fb0689427604/스크린샷_2022-01-15_오후_4.21.47.png)

원암 구성은 로드 밸런서가 중간 스위치 옆에 연결되는 구성이다. (원암이라고 해서 단순히 로드 밸런서와 스위치 간에 연결된 인터페이스가 한 개라는 뜻은 아니다. 다수의 인터페이스로 연결되어 있어도 스위치 옆에 있으면 원암 구성이라고 한다.)

![스크린샷 2022-01-15 오후 11.43.02.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/bee6ff94-2717-404b-8070-7baca2995ca8/스크린샷_2022-01-15_오후_11.43.02.png)

부하 분산을 이용하는 트래픽의 경우, 부하 분산에 사용되는 서비스 IP 정보를 로드 밸런서가 가지고 있어 서버로 유입되는 트래픽은 먼저 로드밸런서를 거친다. 로드밸런서에서는 각 실제 서버로 트래픽을 분산하고, 서버의 응답 트래픽은 다시 로드 밸런서를 거쳐 사용자에게 응답한다.

원암 구성에서는 로드 밸런서를 이용하는 서비스에 대해서만 로드 밸런서를 경유하므로 불필요한 트래픽이 로드 밸런서에 유입되지 않아 로드 밸런서 부하를 줄일 수 있다. 스위치와 로드밸런서 간의 대역폭을 최소화할 수 있고 대역폭이 부족할 때는 그 구간만의 대역폭을 증설하면 되므로 다음에 알아볼 인라인 방식보다 상대적으로 확장에 유리하다.

### 2. 인라인 구성

![스크린샷 2022-01-15 오후 4.22.10.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/2ff567f8-e2c3-44ed-8949-218b1f7162db/스크린샷_2022-01-15_오후_4.22.10.png)

인라인 구성은 스위치에서 서버로 가는 경로 상에 로드 밸런서가 연결되는 구성이다. 인라인 구성은 트래픽이 흐르는 경로에 로드 밸런서가 있어서 서버로 향하는 트래픽이 로드밸런서의 서비스를 받는지 여부와 상관없이 로드밸런서를 모두 통과한다. 모든 트래픽이 로드 밸런서를 경유하므로 로드 밸런서의 부하가 높아진다. 

로드 밸런서에서 처리 하지 않는 트래픽이 로드 밸런서를 거치더라도 그 부하는 크지 않기에, 인라인으로 로드 밸런서를 선정할 때 로드 밸런싱 성능과 패킷 스루풋 성능을 구별해 디자인해야 한다.

 

## 로드 밸런서 동작 모드

### 1. 트랜스패런트(또는 브릿지) 모드

트랜스패런트 구성은 로드 밸런서가 OSI 2계층 스위치처럼 동작하는 구성이다. 즉, 로드 밸런서에서 서비스하기 위해 사용하는 VIP 주소와 실제 서버가 동일한 네트워크를 사용하는 구성이다. 트랜스패런트 구성은 기존에 사용하던 네트워크 대역을 그대로 사용하기에 로드 밸런서 도입으로 인한 IP 네트워크 재설계를 고려하지 않아도 된다. 

### 2. 라우티드 모드

로드밸런서가 라우팅 역할을 수행하는 모드이다. 로드 밸런서를 기준으로 사용자 방향과 서버 방향이 서로 다른 네트워크로 분리된 구성이다. 로드 밸런서는 사용자 방향과 서버 방향의 네트워크를 라우팅으로 연결한다. 라우티드 모드는 원암 구성와 인라인 구성에서 모두 구성할 수 있다. 라우티드 모드는 보안 강화 목적으로 서버쪽 네트워크 사설로 구성해 서버에 직접 접속하는 것을 막는 용도로 사용되기도 한다.

### 3. DSR 모드

DSR(Direct Server Return)은 명칭 그대로 사용자의 요청이 로드 밸런서를 통해 서버로 유입된 후에 다시 로드밸런서를 통하지 않고 서버가 사용자에게 직접 응답하는 모드이다. 로드밸런서에는 응답 트래픽이 유입되지 않으므로 사용자가 요청하는 패킷에 대해서만 관여한다. DSR 모드는 응답할 때, 로드 밸런서를 경유하지 않으므로 원암으로 구성한다.

DSR 모드에서는 요청 트래픽만 로드 밸런서를 통해 흐르므로 로드 밸런서 전체 트래픽이 감소해 로드밸런서 부하가 감소한다. 특히 일반적인 서비스 트래픽인 경우, 서비스 요청 패킷보다 서비스 응답 패킷의 크기가 더 크기 때문에 로드 밸런서의 트래픽 부하 감소에 효과적이다. 스트리밍 서비스와 같이 응답 패킷의 트래픽이 서비스에 필요한 대역폭의 대부분을 차지하는 경우에는 DSR 모드를 통해서 로드 밸런서를 경유하지 않고 응답 패킷의 트래픽을 전달해 로드 밸런서 부하 감소 효과를 극대화할 수 있다.