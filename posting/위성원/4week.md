# 3.4 TCP와 UDP
 - 2, 3계층은 목적지를 정확히 찾아가기 위한 주소 제공이 목적.
 - 4계층에서 동작하는 프로토콜은 도착한 단말 안에서 동작하는 여러 애플리케이션 프로세스 중 1)통신해야 할 목적지 프로세스를
 정확히 찾아가고 2)패킷 순서가 바뀌지 않도록 잘 조합해 원래 데이터를 잘 만들어내기 위한 역할을 함.
 - TCP와 UDP는 그러한 4계층에서 동작하는 프로토콜

### 3.4.1 4계층 프로토콜(TCP, UDP)과 서비스 포트
 - 인캡슐레이션, 디캡슐레이션 과정에 각 계층에서 정의하는 헤더가 추가되고 여러 가지 정보가 들어감.
 - 각 계층을 정의하는 정보, 상위 프로토콜 지시자는 그 중에서도 중요한 정보임.
 - 각 계층을 정의하는 정보는 수신 측의 동일 계층에서 사용하기 위한 정보.
 - ex) 송신 측에서 추가한 2계층 헤더의 MAC 주소 정보는 수신 측의 2계층에서 확인하고 사용됨
 - 4계층에서는 이런 정보로 시퀀스 번호, ACK번호가 있음.
 - 상위 프로토콜 지시자는 디캡슐레이션 과정에서 상위 계층의 프로토콜이나 프로세스를 정확히 찾아가기 위한 목적으로 사용
 - 2계층은 이더 타입, 3계층은 프로토콜 번호, 4계층은 포트 번호가 상위 프로토콜 지시자.
 - 4계층은 TCP와 UDP프로토콜이 담당. 패킷을 분할하고 조립하기 위해 TCP는 시퀀스 번호와 ACK번호를 사용함.
 - 4계층에서는 데이터를 포트로 보냄. TCP/IP에서는 클라이언트-서버 방식으로 프로그램을 구분해 개발하고 서비스함.
 - 포트 번호는 출발지와 목적지를 구분해 처리해야 함(출발지 포트, 목적지 포트).
 - well known포트 : TCP80, TCP443, TCP25같은 잘 알려진 포트. IANA(인터넷 주소 할당 기구)에 등록되고 1023번 이하의 포트 번호를 사용.
 - Registered Port (1024 ~ 49151) : 공식번호와 비공식 번호가 혼재되어 있고 사설 포트 번호로 사용되기도 함.
 
 ### 3.4.2 TCP
  - 실뢰할 수 없는 공용망에서도 정보유실 없는 통신을 보장.
  - 세션을 안전하게 연결, 데이터 분할, 분할된 패킷이 잘 전송되었는지 확인.
  - 패킷에 번호(Sequence Number)를 부여하고 잘 전송되었는지에 대해 응답(Acknowledge Number)함
  - 한꺼번에 얼마나 보내야 수신자가 잘 받아 처리할 수 있는지 전송 크기(Window Size)까지 고려해 통신.
 
 **3.4.2.1 패킷 순서, 응답 번호**
  - TCP에서는 패킷을 잘 분할하고 수신 측이 잘 조합하도록 패킷에 순서를 주고 응답 번호를 부여함.
  - 패킷에 순서를 부여하는 것을 시퀀스 번호, 응답 번호를 부여하는 것을 ACK번호라고 부름.
  - 두 번호의 상호작용으로 순서가 바뀌거나 중간에 패킷이 손실된 것을 파악할 수 있음.
  ![image](https://user-images.githubusercontent.com/52841715/141669510-3200d77e-009a-4262-a2dc-6563f3ee5b2a.png)
  - 보내는 쪽에서 패킷에 번호를 부여하고, 받는 쪽은 이버호의 순서가 맞는지 판단. 순서가 맞으면 다음 번호의 패킷을 요청 (ACK번호)
  - 송신, 응답 둘다 패킷으로 통신하므로 시퀀스 번호, ACK번호는 양방향으로 함께 동작한다.

 **3.4.2.2 윈도 사이즈와 슬라이딩 윈도**
  - 시퀀스번호와 ACK번호를 확인하며 통신하는 것은 송신자와 수신자가 먼 거리에 떨어져 있을 경우 느림.
  - 왕복 지연시간(Round Trip Time, RTT)이 늘어나므로 응답을 기다리는 시간이 더 길어짐.
  - 작은 패킷 하나를 보내고 응답을 받아야만 하나를 더 보낼 수 있다면 모든 데이터를 전송하는데 긴 시간이 걸림.
  - 따라서 최대한 많은 패킷을 한번에 보내고 하나의 응답을 받음. 
  - 너무 많은 패킷을 보내면 네트워크 상태가 안좋았을 때 패킷 유실 가능성이 커짐.
  - 적절한 송신량을 결정하는 것이 중요함. 이때 데이터를 받을 수 있는 크기를 윈도 사이즈함.
  - 이 윈도 사이즈를 네트워크 상황에 따라 조절하는 것을 슬라이딩 윈도라고 함.

 **3.4.2.3 3방향 핸드셰이크**
  - TCP에서는 유실없는 안전한 통신을 위해 통신 시작 전, 사전 연결작업을 진행함.
  - TCP에서는 3번의 패킷을 주고받으면서 통신을 서로 준비하므로 '3방향 핸드셰이크'라고 함.
  - 3방향 핸드쉐이크 진행 상황에 따라 상태정보를 부르는 이름이 다름. 서버에서는 LISTEN상태로 대기.
  - 클라이언트에서 통신을 시도할 때 Syn패킷을 보냄 (SYN-SENT)
  - Syn을 받은 서버는 SYN-RECEIVE 상태로 변경되고 Syn, Ack로 응답함.
  - 이 응답을 받은 클라이언트는 ESTABLISHED 상태로 변경하고, 그에 대한 응답을 서버로 다시 보냄.
  - 서버에서도 클라이언트의 이 응답을 받고 ESTABLISHED 상태로 변경됨.

### 3.4.3 UDP
 - UDP는 4계층 프로토콜이 가져야 할 특징이 거의 없음.
 - 신뢰성 있는 통신을 위해 연결을 미리 확립(3방향 핸드셰이크), 데이터 분할을 위한 패킷 번호 부여 및 응답 작업 등.
 ![image](https://user-images.githubusercontent.com/52841715/141670435-5bf0961f-254d-4d99-8f11-f6f50fe3d58b.png)
 - 데이터 통신은 데이터 전송의 신뢰성이 핵심. 애플리케이션에서 걱정하지 않고 데이터를 만들고 사용하게 하는 것이 핵심.
 - UDP는 데이터 전송을 보장하지 않는 프로토콜이므로 제한된 용도로만 사용됨.
 - 음성 데이터나 실시간 스트리밍과 같이 시간에 민감한 프로토콜 및 애플리케이션을 사용하는 경우.
 - 사내 방송이나 증권 시세 데이터 전송에 사용되는 멀티캐스트처럼 단방향으로 다수의 단말과 통신해 응답을 받기 어려운 환경에 사용.
 - 음성, 동영상은 디지털 환경에서는 연속된 데이터가 아닌 매우 짧은 시간 단위로 잘게 분할한 데이터가 전송되는 형태.
 - 영상에서는 중간에 데이터가 유실되어 프레임이 잘리는 것 보다. 유실된 데이터를 재전송하기 위해 일시적으로 화면이 멈추는 것이 더 어색함.
 - UDP는 TCP와 달리 통신 시작 전, 3방향 핸드셰이크와 같이 사전에 연결을 확립하는 절차가 없음. 
 - UDP의 첫 데이터는 리소스 확보를 위해 인터럽트를 거는 용도로 사용되고 유실됨.
 - 동작하거나 연결 확립은 TCP프로토콜을 사용하고 애플리케이션끼리 모든 준비를 마친 후 실제 데이터만 UDP를 이용하는 경우가 대부분.

# 3.5 ARP
 - 상대방의 MAC주소를 알아내기 위해 사용되는 프로토콜 (Address Resolution Protocol)
 - 데이터 통신을 위해 2계층 물리적 주소인 MAC과 3계층 논리적 주소인 IP가 사용됨.
 - IP주소 체계는 MAC과 연관성이 없기 때문에 이 두 주소를 연계해주기 위한 메커니즘이 필요. 이 때 사용되는 것이 ARP.

# 3.6 서브넷과 게이트웨이
 - 초기 네트워크는 모든 단말이 하나의 네트워크에 존재하는 로컬 네트워크(LAN)를 고려하여 설계되어 통신하는 방법이 매우 간단했다.
이메일과 인터넷 기술의 발달로 작은 LAN 네트워크들이 하나의큰 네트워크로 묶이면서 먼 거리에 있는 다른 LAN 간의 통신이 중요해졌다.
같은 네트워크 내에서의 통신과 원격지 네트워크 간의 통신은 동작방식이나 필요한 네트워크 장비가 모두 다르다. 원격지 네트워크
와의 통신에 사용하는 장비를 게이트웨이라고 부르고 3계층 장비(라우터와 L3 스위치)가 이 역할을 할 수 있다.
