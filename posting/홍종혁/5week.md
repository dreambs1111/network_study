# 스위치 : 2계층 장비
> ## [4.1] 스위치 장비 동작
> ## [4.2] VLAN
> ## [4.3] STP
---
```
스위치 : 네트워크 중간에서 패킷을 받아 필요한 곳에만 보내주는 네트워크 중재자 역활

스위치는 아무 설정 없이 네트워크에 연결해도 MAC 주소를 기반으로 패킷을 전달할 수 있음

스위치의 기능
    - 기본 기능 (패킷을 전달)
    - VLAN : 한 대의 장비에서 논리적으로 네트워크를 분리
    - STP : 네트워크의 루프를 방지
```
---
> ## [4.1] 스위치 장비 동작
- 스위치 : 네트워크에서 통신을 중재하는 장비
    - 스위치가 없던 오래된 이더넷 네트워크 : 패킷전송시 서로 경합으로 인한 네트워크 성능저하가 컸음
    - 스위치를 사용하면 여러 단말이 한꺼번에 통신할 수 있어 패킷의 병목현상이 해결되고 통신 효율성이 향상됨

- 스위치의 핵심 역할 : 누가 어느 위치에 있고 실제 통신이 시작되면 알고있는 위치로 패킷을 정확히 전송하는 것
    - 이런 동작에서 스위치가 2계층 주소를 이해하고 MAC주소와 단말이 위치하는 인터페이스 정보를 매핑한 MAC 주소 테이블을 갖고 있어서 가능
    (그림 4.4)
    - **_스위치 작동_**
        1. 전송하려는 패킷의 헤더 안에 2계층 목적지 주소 확인
        2. MAC 주소 테이블에서 해당주소 포트 확인
        3. 해당 패킷 그 포트로 전송
        - 이런 역할을 수행하기 위해 스위치는 MAC주소와 포트가 매핑된 MAC 주소 테이블이 필요
        - if 테이블에 없는 도착지 주소를 가진 패킷
            - 전체 포트로 패킷 전송
        - if 테이블에 주소가 존재
            - 매핑된 포트로만 패킷 전송

__스위치의 이런 동작 방식을 다음 3가지로 정리 가능__
```
1. 플러딩(Flooding)
2. 어드레스 러닝(Address Learning)
3. 포워딩/필터링(Fowarding/Filtering)
```
> ### [4.1.1] 플러딩(Flooding)
- 스위치는 부팅시 네트워크 관련 아무런 정보가 없음
    - 이때의 스위치는 네트워크 통신을 중재하는 역할을 못하고 허브처럼 동작
        - 허브는 패킷이 들어온 포트를 제외 모든 포트로 패킷을 전달
        - 스위치가 허브와 같이 작동되는 동작방식을 플러딩이라 한다
        (그림 4.6)
        - 스위치는 LAN에서 동작하므로 자신이 정보를 갖고 있지 않더라도 어딘가에 장비가 있을수 있다고 가정하기 때문
- 플러딩은 스위치의 정상적인 동작이지만 요청이 많아지면 스위치에 부하가 걸림
- 패킷이 스위치에 들어오면 해당 패킷 정보의 MAC 주소를 보고 이를 학습해 MAC 주소 테이블을 만든 후 이를 통해 패킷을 전송

__비정상적인 플러딩__
```
- 스위치가 패킷을 플러딩한다는것은 제 기능을 못한다는뜻(물론 동작자체는 정상이지만)
- 아무 이유없이 스위치가 패킷을 플러딩한다면 고장 또는 외부의 공격임을 알아야한다
    - 엉뚱한 MAC주소를 습득시키거나 MAC테이블을 꽉 차게 해 플러딩유도가능
    - 또는 ARP포이즈닝 기법을 이용해 모니터링해야 할 IP의 MAC주소가 공격자 자신인것처럼 속여 통신하는 방법을 사용하기도 함
```

> ### [4.1.2] 어드레스 러닝
- 스위치가 패킷의 도착지 MAC주소를 확인하고 원하는 포트로 포워딩시 MAC주소 테이블의 생성과 유지가 필요
    - MAC주소 테이블
        - 어느 포트에 어떤 장비가 연결되어 있는지에 대해 정보가 저장된 임시 테이블
- 이런 MAC주소 테이블을 만들고 유지하는 과정을 어드레스 러닝이라고 한다.

- 어드레스 러닝
    - 패킷의 출발지 mac주소 정보를 이용
    - 패킷이 특정 포트에 들어오면 스위치에는 해당 패킷의 출발지mac주소와 포트번호를 mac주소 테이블에 기록
        - ex. N번포트에서 들어온 패킷의 출발MAC주소가 1111이라면 N번포트에 1111 MAC주소 를가진 장비가 있다
    - 어드레스 러닝은 출발지의 mac주소를 사용하므로 브로드캐스트나 멀티캐스트에 대한 mac주소를 학습할 수 없다
        - 이유 : 두가지 모두 목적지 mac주소 필드에서만 사용하기 때문

__사전 정의된 mac주소 테이블__
```
- 스위치는 mac어드레스 러닝 작업 전에도 사전에 미리 정의된 mac주소 정보를 가지고 있다
- 사전 정의된 주소는 패킷처리 목적이 아닌 대부분 스위치 간 통신을 위해 사용되는 주소
- show mac address-table 명령어로 확인할 수 있으며 스위치 자체 처리되는 주소는 특정 포트로 내보내는 것이 아니라
스위치에서 자체 처리하므로 인접 포트 정보가 없거나 CPU혹은 관리 모듈을 지칭하는 용어로 표기됨
```

> ### [4.1.3] 포워딩/필터링
- 필터링 : 스위치가 MAC테이블을 이용해 패킷을 해당포트로 포워딩할때 다른포트로 보내지 않는것
- 스위치에서 포워딩과 필터링은 여러 포트에서 동시 수행 가능
    - 통신이 다른 포트에 영향을 미치지 않으므로 다른 포트에서 기존 통신작업으로부터 독립적으로 동작할 수 있다

- 일반적으로 유니캐스트에 대해서만 포워딩과 필터링 작업을 수행
    - BUM트래픽이라고 부르는 브로드캐스트, 언노운 유니캐스트, 멀티캐스트와는 조금 다르게 동작
    - 출발지 MAC주소로 브로드캐스트나 멀티캐스트 모두 출발지가 사용되지 않으므로 이런 트래픽은 포워딩이나 필터링없이 모두 플러딩
    - 언노운 유니캐스트도 MAC 주소 테이블에 없는 주소이므로 동일하게 플러딩

__LAN에서의 ARP - 스위치 동작__
```
- 이더넷_TCP/IP 네트워크에서는 스위치가 유니캐스트를 플러딩하는 경우는 거의 없다
- 패킷을 만들기 전에 ARP브로드캐스트가 먼저 수행되어야 하므로 유니캐스트보다 ARP브로드캐스트가 먼저 네트워크에 전달되기 때문
- 이 ARP를 이용한 MAC주소 습득 과정에서 이미 MAC주소 테이블이 생성되고 유니캐스트 통신이 시작
- ARP와 MAC테이블은 일정 시간 동안 지워지지 않는데 이 시간을 에이징타임(Aging Time)이라고 한다
- 일반적으로 MAC테이블의 에이징 타임이 단말의 ARP에이징 타임보다 길어 이더넷 네트워크를 플러딩 없이 효율적으로 운영할 수 있다
```

> ## [4.2] VLAN
```
- 가상화는 IT 트렌드에서 많은 비중을 차지하는 키워드 중 하나
- 네트워크에서도 다양한 가상화 기술이 쓰이고 있는데 스위치에서는 오래 전부터 VLAN이라는 가상화 기술을 사용해왔다
```
- ‘VLAN은 물리적 배치와 상관없이 LAN을 논리적으로 분할, 구성하는 기술’
- 기업과 같이 여러 부서가 함께 근무하면서 각 부서별로 네트워크를 분할할 때는 네트워크를 여러 개 운영해야함
- 과도한 브로드캐스트로 인한 단말들의 성능 저하, 보안 향상을 위한 차단 용도, 서비스 성격에 따른 정책 적용과 같은 이유로 네트워크는 분리되어야 한다

- VLAN을 나누면 하나의 장비를 서로 다른 네트워크를 갖도록 논리적으로 분할한 것이므로 유니캐스트 뿐 아니라 브로드 캐스트도 VLAN 간에 통신을 할 수 없다
    - 서로 다른 네트워크에 있는 통신이 되므로 3계층 장비 필요
- 같은 층에서 부서별로 네트워크를 분리하거나 물리적으로 다른 층에 있는 단말을 하나의 VLAN을 사용해 동일한 네트워크로 묶을 수 있다
    - 당연히 분리된 단말(네트워크)간에는 3계층 장비를 통해 통신하게 된다

> ### [4.2.2] VLAN의 종류와 특징
- VLAN 할당 방식
    - 포트기반VLAN
        - 스위치를 논리적으로 분할해 여러 네트워크에 사용하는 것
        - 우리가 일반적으로 언ㄷ급하는 대부분의 VLAN
        - 어떤 단말이 접속하든지 스위치의 특정 포트에 VLAN을 할당하면 할당된 VLAN에 속한다
    - MAC주소 기반의 VLAN
        - 스위치의 고정 포트에 VLAN을 할당하는 것이 아니라 스위치에 연결되는 단말의 MAC 주소를 기반으로 VLAN을 할당
        - 이 경우 단말이 연결되면 단말의 MAC주소를 인식한 스위치가 해당 포트를 지정된 VLAN으로 변경
        - 단말에 따라 VLAN정보가 바뀔 수 있어 다이나믹 VLAN이라고 부른다

__참고__
```
- 데이터 센터에서의 스위치 VLAN은 포트기반 VLAN
- 오피스나 캠퍼스 네트워크에서도 포트 기반 VLAN 구성이 일반적이지만 사용자의 이동성을 요구하는 최근 스마트 오피스의 요구로 MAC기반 VLAN 구성이 점점 더 많이 사용되고 있다.
```

> ### [4.2.3] VLAN 모드(Trunk/Access) 동작 방식
- 포트 기반 VLAN
    - 스위치의 각 포트에 각각 사용할 VLAN을 설정하는데 한 대의 스위치에 연결되더라도 서로 다른 VLAN 포트끼리 통신 불가능
    - 3계층 장비 필요

- 여러 개의 VLAN이 존재하는 상황에서 스위치를 서로 연결해야 하는 경우에는 각 VLAN끼리 통신하려면 VLAN 개수만큼 포트를 연결해야 한다
- VLAN으로 분할된 스위치는 물리적인 별도의 스위치처럼 취급된다
    - ex.
    - 이 문제의 해결법(VLAN 태그 기능)
        - 태그 기능은 하나의 포트에서 여러개의 VLAN을 함께 전송할 수 있게 해준다
        - 이 포트를 태그(Tagged)포트 or 트렁크(Trunk) 포트라고 한다

- 여러개의 VLAN을 동시에 전송해야 하는 태그 포트는 통신시 이더넷 프레임간에 VLAN ID필드를 끼워 넣어 이 정보를 이용
    - ex) 태그 포트로 패킷을 보낼 때는 VLAN ID를 붙이고 수신 측에서는 이 VLAN ID를 제거하면서 VLAN ID의 VLAN으로 패킷을 전송할 수 있음
__참고__
```
- 스위치 간 VLAN 정보를 보낼 수 있는 포트의 일반적인 용어는 '태그 포트'
- 트렁크 포트는 시스코에서 사용하는 명칭이며 다른 네트워크 제조사에서는 다른의미이기 때문에 조심합시다
```

- 태그 포트를 사용하면 VLAN마다 통신하기 위해 필요했던 여러 개의 포트를 하나로 묶어 사용가능하므로 포트의 낭비를 없앨 수 있다
- 태그 포트기능이 스위치에 생기면서 생긴 변화
    - 스위치의 패킷 전송에 사용하는 MAC 주소 테이블에 변화
        - 다른 VLAN 끼리 통신하지 못하도록 MAC 테이블에 VLAN을 지정하는 필드가 추가됨
        - 즉, 하나의 스위치에서 VLAN 을 이용해 네트워크를 분리하면 VLAN 별로 MAC 주소 테이블이 존재하는것처럼 작동

- 일반적인 포트를 언태그(Untagged) 포트, 액세스(Access) 포트라고 함
    - 하나의 네트워크에 속한 서버의 경우
    - 패킷이 들어올 경우 같은 VLAN 으로만 패킷을 전송
- VLAN 정보를 넘겨 여러 VLAN 이 한꺼번에 통신하도록 해주는 포트를 태그 포트, 트렁크 포트라고 함
    - 여러 네트워크가 동시에 설정된 스위치 간의 연결
    - 패킷이 들어올 경우 태그를 벗겨내면서 태그된 VLAN 으로 패킷을 전송

> ## [4.3] STP
```
IT 환경에서는 SPoF(Single Point of Failure : 단일 장애점)로 인한 장애를 피하기 위한 다양한 노력을 한다
- SPoF 란?
    하나의 시스템이나 구성 요소에서 고장이 발생했을 때 전체 시스템의 작동이 멈추는 요소
    네트워크에서는 이런점을 대비하여 이중화, 다중화된 네트워크를 디자인하고 구성
```
- 네트워크에서 스위치를 하나로 구성시 그 스위치에 장애가 발생하면 전체 네트워크에 장애가 발생
    - 이런 SPoF 를 피하기 위해 스위치 두 대로 네트워크를 디자인하지만 두 대 이상의 스위치로 디자인하면 패킷이 네트워크를 따라 계속 전송되므로 네트워크를 마비시킬 수 있다
    - 이런상황을 네트워크 루프라고 한다
        - __예방법__이 필요

> ### [4.3.1] 루프란?
- 루프는 말 그대로 네트워크에 연결된 모양이 고리처럼 되돌아오는 형태로 구성된 상황
    - 이 상황을 바로 인지하는 경우는 드물지만 루프 상황이 발생했을 때 네트워크가 마비되고 통신이 안되는 상황이 발생
    - 3가지 정도의 이유가 있지만 보통 브로드캐스트 스톰으로 인한 문제

> #### [4.3.1.1] 브로드캐스트 스톰
1. 루프 구조로 네트워크가 연결된 상태에서 단말에서 브로드캐스트를 발생시키면 스위치는 이 패킷을 패킷이 유입된 포트를 제외하고 모든 포트로 플러딩
2. 플러딩한 패킷은 다른 스위치로 보내지고 패킷을 받은 스위치는 다시 플러딩
3. 이 루프 구조 상태에서 패킷이 계속 돌아가는것이 브로드 캐스트 스톰

- 3계층 헤더에는 TTL(Time to Live) 라는 패킷 수명이 있지만 스위치가 확인하는 2계층에서는 패킷하나가 전체 네트워크 대역폭을 차지할 수 있다
- 이 경우 브로드캐스트 스톰이 전체 대역폭과 시스템 리소스를 차지하며 통신이 불가능해지게 된다

__브로드 스톰 증상__
```
1. 네트워크에 접속된 단말의 속도가 느려짐(CPU 사용률 증가)
2. 네트워크 접속 속도가 느려짐 (통신이 불가능한 수준)
3. 네트워크에 설치된 스위치에 모든 LED들이 동시에 빠른속도로 깜빡임
-> 케이블을 제거하기 전까지 네트워크가 마비된 것과 같은 증상
```

> #### [4.3.1.2] 스위치 MAC 러닝 중복 문제

