# 로드 밸런서/방화벽 : 4계층 장비(세션 장비)

> ## 6.1 4계층 장비의 특징
> ## 6.2 로드 밸런서
> ## 6.3 방화벽
> ## 6.4 4계층 장비를 통과할 때의 유의점(세션 관리)
---
> ## 6.1 4계층 장비의 특징
- 4계층 장비는 TCP와 같은 4계층 헤더에 있는 정보를 이해하고 이 정보들을 기반으로 동작
- 4계층 프로토콜 동작에 대한 깊은 이해 없이 4계층 장비를 2,3계층 네트워크 장비처럼 설계, 운용하면 여러가지 문제가 발생한다

- 기존 네트워크 장비와 다른 점을 위주로 이해해보기
    - 세션 테이블과 그 안에서 관리하는 세션 정보가 가장 중요
    - 4계층 이상에서 동작하는 로드밸런서, 방화벽과 같은 장비를 '세션 장비'라고 부른다

> __세션 테이블__

- 세션 장비는 세션 테이블 기반으로 운영
- 세션 정보를 저장, 확인하는 작업 전반에 대한 이해 필요
- 세션 정보는 세션 테이블에 남아있는 라이프타임이 존재(이부분 고려 필요)

- Symmetric(대칭)경로 요구
    - Inbound / Outbound 경로 일치 요구
- 정보 변경(로드밸런서의 경우)
    - IP주소가 변경되며 확장된 L7 로드 밸런서(ADC)는 애플리케이션 프로토콜 정보도 변경된다

__세션 장비의 이런 요소들은 서비스에 영향을 끼칠수 있으므로 방화벽, NAT, 로드밸런서(네트워크 중간에서 세션을 기반으로 동작하는 기능들)와 같은 장비들은 네트워크 인프라 뿐 아니라 시스템 설계, 애플리케이션 개발에서도 세션 장비에 대해 고려해야 한다__

> ## 6.2 로드밸런서
- 로드 밸런서 : 서버나 장비의 부하를 분산하기 위해 사용하는 장비
- 기능 :트래픽을 분배
    - 4계층 이상에서 동작하면서 IP주소나 4계층 정보, 애플리케이션 정보를 확인, 수정하는 기능도 있다

- 가장 많이 사용되는 분야 : 웹서버의 부하 분산
    - 이유 : 사용자 1천 명의 요청을 처리해주는 서버보다 5천명의 요청을 동시에 처리해주는 서버는 5배보다 훨씬 비싸기 때문
    - 따라서 작은 장비 여러 대를 묶어 사용하는 방법을 선호

- 작은 시스템 여러 대를 운영하더라도 사용자는 서버의 배치와 상관없이 하나의 서비스로 보여야 한다

- 로드 밸런서가 서비스에 사용하는 대표IP를 갖고 그 하위에 시스템이 늘어나면 로드밸런서가 각 시스템의 실제 IP로 알아서 변경해서 요청을 보낸다
- 4, 7계층의 로드밸런서?
    > L4 로드 밸런싱
    - 일반적인 로드밸런서가 동작하는 방식
    - TCP, UDP정보(특히, 포트넘버)를 기반으로 로드 밸런싱을 수행
    - 최근 로드밸런서는 L4, L7모두 지원하므로 L4전용 로드밸런서는 거의 없지만 일단 L4에 대한 정보로 분산처리를 하는 경우 L4로드 밸런스라 한다

    > L7 로드 밸런싱
    - HTTP, FTP, SMTP 같은 어플리케이션 프로토콜 정보를 기반으로 로드밸런싱 수행
    - HTTP 헤더 정보나 URL와 같은 정보를 기반으로 프로토콜을 이해, 부하를 분산
    - ADC(Application Delivery Controller)라고 부르며 프록시(Proxy)역할을 수행
    - 스쿼드(Squid)나 Nginx에서 수행하는 리버스 프록시(Reverse Proxy)와 유사한 기능을 갖고 있음

>> ### 6.2.1 L4 스위치
    - L4스위치 내부 동작은 4계층 로드밸런서지만 외형은 스위치처럼 여러개의 포트를 가지고 있음

    - 서버형 로드밸런서, 소프트웨어 형태의 로드 밸런서도 있지만 가장 대중적인 로드 밸런서는 다양한 네트워크 구성이 가능한 스위치형 로드밸런서

    - L4스위치 기능 : 부하 분산, 성능 최적화, 리다이렉션

    - 동작 방식 :
        - 클라이언트는 L4스위치의 가상 IP를 목적지로 서비스 요청
        - L4스위치가 가상 IP를 리얼 IP로 변경하여 재 전송

>> ### 6.2.2 ADC(Application Delivery Controller)
    - ADC는 애플리케이션 계층에서 동작하는 로드밸런서

    - 4계층에서 동작하는 L4와 차이점
        - 애플리케이션 프로토콜의 헤더와 내용을 이해하고 동작하기 때문에 다양한 부하분산, 정부 수정, 정보의 필터링 가능
        - 이런 상세한 동작을 위해 Proxy로 동작
        - 대부분의 ADC는 4계층 스위치의 기능을 포함
        - 대부분의 ADC는 4~7계층까지 로드밸런싱 기능 제공
            - Failover(장애 극복 기능)
            - Redirection
            - Compression(압축)
            - 콘텐츠 변환 및 재작성
            - 인코딩 변환
            - 어플리케이션 프로토콜 최적화
        - 등 다양한 기능이 가능

    - 플러그인 형태로 보안 강화 기능을 추가로 제공 
        - WAF(Web Application Firewall)기능, HTML, XML 검증&변환 수행 가능

>> ### 6.2.3 L4스위치 vs ADC 

> L4스위치 : 

    - 4계층에서 동작
    - CP,UDP정보를 기반으로 부하를 분산
    - TCP 계층에서의 최적화와 보안기능 제공
    - 정리 : TCP 레벨의 간단한 DoS(Denial of Service)공격을 방어하거나 서버의 부하를 줄이기 위해 TCP 세션 재사용과 같은 보안과 성능을 높여주는 기능

> ADC :

    - 애플리케이션 프로토콜 이해 및 애플리케이션 내용에 대한 분산
    - 리다이렉션
    - 최적화 제공 (L4 스위치보다 더 다양한 기능)

    - 성능 최적화를 위해 서버에서 수행하는 작업 중 부하가 많이 걸리는 작업을 별도로 수행
    - 그 중 하나가 이미지나 정적 콘텐츠 캐싱(Caching)기능
    - 압축을 통해 컨텐츠를 압축하여 웹서버의 부하를 줄임

    - 정리 : 하드웨어 가속이나 소프트웨어 최적화를 통해 이런 부하가 걸리는 작업을 최적화 하는 기능

> __최근 SSL프로토콜을 사용하는 비중이 늘면서 웹 서버에 SSL 암복호화 부하가 늘고 있다. 
> ADC에서는 SSL의 엔드포인트로 동작해 클라이언트에서 ADC까지의 구간을 SSL로 처리해주고 ADC와 웹 서버 사이를 일 반 HTTP를 이용해 통신
> 이런 기능을 사용할 때는 웹 서버의 여러 대의 SSL 통신을 하나의 ADC에서 수용하기 위해 ADC예 전용 SSL 가속 카드를 내장

