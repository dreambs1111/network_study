# 5장 라우터 / L3스위치 : 3계층 장비
---
> ## [5.1] 라우터의 동작 방식과 역할
> ## [5.2] 경로지정 - 라우팅/스위치
> ## [5.3] 라우팅 설정 방법
---


> ## [5.1] 라우터의 동작 방식과 역할

- 라우터 : 3계층에서 동작하는 대표적인 네트워크 장비

    - 간단하게 이름 그대로 경로를 지정해주는 장치
    - 라우터는 원격지 네트워크와 연결시 필수 네트워크 장비


> __3계층에도 스위치가 있어요__

```
- 3계층에도 3계층에서 동작하는 L3 스위치가 있다. 
- 소프트웨어 / 하드웨어
- 다양한 기능 / 패킷 전송 속도 최적화
- 각각 라우터 / 스위치 
- 로 나누었지만 기술의 발달로 최근에는 둘의 차이를 구분하기 어렵다
앞으로의 내용은 L3, 라우터 모두 해당되는 내용이다

```

- 라우터의 3가지 동작 방식
    - __[경로지정]__ : 패킷이 들어오면 IP주소와 라우팅 테이블을 비교해 최선의 경로로 패킷을 전송
    - __[브로드캐스트 컨트롤]__ : 패킷의 목적지 주소가 라우팅 테이블에 없으면 패킷을 버림
    - __[프로토콜 변환]__ : 패킷 포워딩 과정에서 기존 2계층 헤더 정보를 제거한 후 새로운 2계층 헤더를 만들어냄

> ### [5.1.1] 경로 지정

- 경로 지정은 라우터의 가장 중요한 역할
    1. 경로 정보를 모아 라우팅 테이블을 만든다
    2. 패킷이 들어오면 도착지 IP주소를 확인해 경로를 지정한다
    3. 패킷을 포워딩한다
- IP주소는 네트워크와 호스트로 나뉜 계층구조로(3.3.1참고) 이루어져 있다
    - 이로인해 IP주소를 확인해 로컬/원격지 네트워크를 구분할 수 있고 네트워크 주소를 기반으로 경로를 찾아갈 수 있다
    - 라우터는 이 IP주소를 확인해 원격지에 있는 적절한 경로로 패킷을 포워딩

> ### [5.1.2] 브로드캐스트 컨트롤(Broadcast Control)

- 스위치는 패킷의 도착지 주소를 모르면 어딘가에 존재할지 몰르기 때문에 위해 패킷을 모든 포트로 플러딩
    - 때문에 쓸모없는 패킷이 전송되서 전체 네트워크에 무리가 갈 수 있다고 생각하겠지만 LAN은 크기가 작아 플러딩에 대한 영향이 작고 패킷을 확인후 폐기하기 때문에 큰 무리를 주지 않는다

- 반면 라우터는 패킷을 원격지로 보내는 것이 목표이며 3계층에서 동작하고 분명한 도착지 정보가 있을시에만 통신을 허가한다
    - 만약 스위치와 같이 플러딩한다면 인터넷의 대역폭이 쓸모없는 패킷으로 가득차 통신 불능이 될 수 있다

- 따라서 라우터는 로컬 네트워크를 제외하고 경로 습득 설정을 하지 않으면 패킷을 포워딩할 수 없다
- 라우터의 기본 동작은 멀티캐스트 정보를 습득하지 않고 브로드캐스트 패킷을 전달하지 않는것
    - 이를 이용해 브로드캐스트가 다른 네트워크로 전파되는 것을 막을 수 있다
    - 이를 브로드캐스트 컨트롤 / 멀티캐스트 컨트롤 이라 한다
    - 네트워크에 브로드 캐스트가 많을경우 라우터로 네트워크를 분리하여 성능을 높일 수 있다!

> ### [5.1.3] 프로토콜 변환

- 라우터의 3번째 역할은 서로 다른 프로토콜로 구성된 네트워크를 연결하는 것
- 현대 네트워크는 이더넷으로 수렴하므로 이 역할이 많이 줄었지만 과거에는 LAN에서 사용하는 프로토콜과 WAN에서 사용하는 프로토콜이 전혀 다른, 완전히 구분된 공간이었다
    - LAN : 다수 컴퓨터가 함께 통신하는데 초점
    - WAN : 원거리 통신이 목적
- 이 당시에는 LAN기술이 WAN기술로 변환되야만 인터넷과 같은 원격지 네트워크 통신이 가능했고 이를 라우터가 담당했다

- 라우터는 패킷이 오면 2계층 헤더를 벗겨내고 3계층 주소 확인후 2계층 헤더를 새로 입힌다
- 이를 이용해 프로토콜이 다른 장치들 간에 통신이 가능하게 된다

> ## [5.2] 경로지정 - 라우팅/스위칭

- 라우터가 패킷 처리시 크게 두 가지 작업을 수행
    - 경로 정보를 얻어 경로 정보를 정리하는 역할
    - 정리된 경로 정보를 기반으로 패킷을 포워딩하는 역할
- 좀 더 쉽게 말하면 최적 경로 확보와 패킷 포워딩
- 라우터는 라우터 테이블에 없는 목적지를 가진 패킷이 들어오면 버리기 때문에 경로 정보를 충분히 가지고 있어야 라우터가 정상 작동한다

- 라우터는 다양한 경로 정보를 얻을 수 있지만 원하는 목적지 정보와 정확히 일치하지 않는 경우가 더 많다
    - 라우터는 서브넷 단위로 라우팅 정보를 습득하고 라우팅 정보를 최적화하기 위해 서머리 작업을 통해 여러 개의 서브넷 정보를 뭉쳐 전달
    (서머리 작업은 뭔지 모르겠다... 서브넷은 하나의 네트워크가 분할되어 나눠진 작은 네트워크)
    - 그래서 라우터에 들어온 패킷의 목적지 주소와 라우터가 갖고있는 라우팅 테이블이 정확히 일치하지 않아도 목적지에 가장 근접한 정보를 찾아 패킷을 포워딩해야한다

> ### [5.2.1] 라우팅 동작과 라우팅 테이블

- 현대 인터넷에서는 단말붙터 목적지까지의 경로를 모두 책임지는 것이 아니라 인접한 라우터까지만 경로를 지정하면 인접 라우터에서 최적의 경로를 다시 파악한 후 라우터로 패킷을 포워딩
- 이 기법을 한 단계씩 뛰어넘는다는 의미로 Hop-by-Hop 라우팅이라 부르고 라우터는 패킷이 목적지로 가는 전체경로를 파악하지 않고 최적의 넥스트 홉을 선택해서 보내줌

- 넥스트 홉을 지정시에는 일반적으로 세 가지 방법을 사용할수 있다
    1. 다음 라우터의 IP를 지정하는 방법 (넥스트 홉 IP 주소)
    2. 라우터의 나가는 인터페이스를 지정하는 방법
    3. 라우터의 나가는 인터페이스와 다음 라우터의 IP를 동시에 지정하는 방법

- 라우터에서 넥스트 홉을 지정시 일반적으로 1번 방법을 사용한다
- 상대방 넥스트 홉 라우터의 IP를 모르더라도 MAC주소 정보를 알아낼 수 있을 때만 2번 사용
    ex. WAN구간에서 PPP나 HLDC같은 프로토콜 사용시에는 이런 경우가 발생한다
- 보통 인터페이스 설정시 라우터의 나가는 물리 인터페이스를 지정하는것이 일반적이지만 IP와 인터페이스를 동시에 사용할 때는 VLAN 과 같은 논리적인 인터페이스를 사용할 수 있다
-> 인터페이스란 서로 다른 두 개의 시스템 사이에서 정보나 신호를 주고받는 지점

- 라우터가 패킷을 어디로 포워딩할지 경로를 선택시에는 출발지는 고려하지 않는다
    - 그래서 라우팅 테이블을 만들 때는 목적지 정보만 수집하고 패킷이 들어오면 목적지 주소를 확인해 패킷을 넥스트 홉으로 포워딩

- 라우팅 테이블에 저장하는 데이터
    - 목적지 주소
    - 넥스트 홉 IP주소, 나가는 로컬 인터페이스(선택)

- 라우터에서 패킷의 출발지 주소를 이용해 라우팅하도록하는 PBR(Policy-Based Routing)기능도 있지만 목적지 주소만 수집하는 라우팅 테이블로는 이 기능을 활성화 할 수 없고 별도 설정이 필요
    - 단, 이 경우 다른 라우터와의 호환이 되지 않으며 관리가 어렵고 문제가 발생하면 해결이 어려우므로 특별한 목적으로만 사용

> __루프가 없는 3계층 : TTL(Time To Live)__
3계층의 IP 헤더에는 TTL이라는 필드가 있어서 패킷이 네트웨크에 살아있을 수 있ㄴ는 시간을 제한, TTL이라는 수명값이 0이 되면 네트워크 장비에서 버려진다. TTL은 초와 같은 시간이 아니라 하나의 홉을 지날때마다 1씩 감소한다

> ### [5.2.2] 라우팅라우터가 경로 정보를 얻는 방법)
- 라우터가 경로 정보를 얻는 방법은 크게 3가지 방법으로 구분할 수 있다
    1. 다이렉트 커넥티드
        - IP주소를 입력시 사용된 IP주소와 서브넷 마스크로 해당 IP주소가 속한 네트워크 주소정보를 알 수 있다
        - 라우터나 PC에서는 이 정보를 통해 라우팅 케이블을 자동으로 만듬
        - 이 경로 정보를 다이렉트 커넥티드라고 부른다
        - 다이렉트 커넥티드를 통해 생성된 정보는 강제로 지울 수 없고 해당 네트워크 설정을 삭제하거나 해당 네트워크 인터페이스가 비활성화 되어야만 자동으로 사라짐

    2. 스태틱 라우팅
        - 관리자가 목적지 네트워크와 넥스트 홉을 라우터에 직접 지정해 경로 정보를 입력하는 것을 스태틱 라우팅이라 한다
        - 관리자가 직접 지정하므로 라우팅 정보를 매우 직관적으로 설정및 관리할 수 있다.
        - 다이렉트 커넥티드와 마찬가지로 강제로 지울수 없고 해당 네트워크 설정을 삭제하거나 해당 네트워크 인터페이스가 비활성화 되어야만 자동으로 사라짐
            - 예외 사항도 존재
    
    3. 다이타믹 라우팅
        - 스태틱 라우팅은 네트워크를 쉽게 관리할 수 있는 좋은 방법이지만 이것만으로는 관리가 어려움
        - 스태틱 라우팅은 라우터 너머의 다른 라우터의 상태 정보를 파악할 수 없어 장애 발생시 대체 경로로 패킷을 보낼 수 없기 때문
        - 또한 관리하는  네트워크 수가 많아지면 연결이 복잡해지면 직접 라우팅을 추가/삭제 하는데 한계가 있음

        - 다이나믹 라우팅은 주기적으로 또는 상태 정보가 변경될 때마다 경로 정보를 교환하므로써 장애 발생시 상황을 인지해 대체 경로로 자동 포워딩 가능
        - 관리자의 수동 개입없이 라우터끼리 정보교환만으로 장애를 인지하고 트래픽을 우회함으로써 대부분의 네트워크에서는 다이나믹 라우팅이 사용된다

> ### [5.2.3] 스위칭(라우터가 경로를 지정하는 방법)
- 라우팅을 다시 설명해보자 
    - 다양한 방법으로 경로 정보를 얻고 그 정보 중 최적의 경로로 생각되는 경로를 라우팅 테이블에 올려 유지하는 과정
    - 이런 최적 경로 정보를 유지하는 것은 라우터에 패킷이 왔을때 빨리 포워딩하는 것을 도와주기 위해
    - 패킷이 들어와 라우팅 테이블을 참조하고 최적의 경로를 찾아 라우터 외부로 포워딩하는 작업을 __스위칭__이라고 한다
        - 2계층의 스위치와 비슷하지만 다른용어
        - 3계층 장비인 라우터가 패킷 경로를 지정해 보내는 작업을 의미

- 패킷을 최선의 경로로 내보낼때 고려해야할 점
    - 들어온 패킷의 목적지가 라우팅 테이블에 있는 정보와 완벽한 일치가 아닐 경우
    - 이 경우 롱기스트 프리픽스 매치(Longest Prefix Match)와 같은 기법을 이용해 갖고있는 경로 정보중 가장 가까운 경로로 선택
        - 롱기스트 프리픽스 매치 : 패킷을 포워딩할때 라우팅 테이블에서 목적지와 가장 유사한 라우팅 경로을 선택하는 알고리즘

- 한번 스위칭 작업을 수행한 정보는 캐시에 저장하고 동일 패킷 정보가 들어오면 라우팅 테이블보다 캐시를 먼저 확인한다
    - 보통 패킷 네트워크에서 데이터를 보내기 위해 동일한 출발지& 목적지 IP, 포트번호로 여러 개의 패킷이 연속적으로 들어오기 때문에
    - 캐시 기술도 다양하다. 단순히 목적지 IP만 캐시하는 경우, 출발지와 목적지 모두 캐시하는 경우, 포트번호까지 저장하는 경우 등

> ### [5.2.4] 라우팅, 스위칭 우선순위
- 라우팅 테이블은 가장 좋은 경로 정보만 모아놓은 핵심 정보
- 일반적인 경로 정보를 모아놓은 토폴로지 테이블에서 좋은 경로 정보의 우선순위는 경로 정보를 받은 방법과 거리를 기준으로 정함

- 만약 목적지 네트워크 정보가 동일한 서브넷을 사용하는 경우
    - 정보를 얻은 소스에 따라 가중치를 정하게 된다
    - 가중치의 값은 크게 3가지로 나눌 수 있다
        - 내가 갖고 있는 네트워크(다이렉트 커넥티드)
            - 1 순위 
        - 내가 경로를 직접 지정한 네트워크(스태틱 라우팅)
            - 2 순위 
        - 경로를 전달받은 네트워크(다이나믹 라우팅)
            - 3 순위
    - 물론, 관리자가 임의로 우선순위를 조장할 수 있다
    - 이런 우선순위를 AD(Administrative Distance, 관리 거리)라고 하며 라우터 생산업체마다 AD값이 조금씩 다르다

- 여기서 가중치 값까지 동일한 경우에는 코스트(Cost)값으로 우선순위를 정한다
- 코스트 값까지 동일한 경우에는 ECMP(Equal-Cost Multi-Path)기능으로 동일한 코스트 값을 가진 경로 값 정보를 모두 활용해 트래픽을 분산
- 코스트 값은 일종의 거리를 나타내는 값으로 라우팅 프로토콜마다 기준이 다르다
    - RIP는 흡수, OSPF는 대역폭, EIGRP는 다양한 값들을 연산해 나온 값으로 코스트를 지정
    - 참고 : https://ryusstory.tistory.com/entry/%EB%9D%BC%EC%9A%B0%ED%8C%85-%EA%B8%B0%EB%B3%B8%EA%B0%9C%EB%85%90-%EC%A0%95%EB%A6%AC-RIP-EIGRP-OSPF

> ## [5.3] 라우팅 설정 방법

> ### [5.3.1] 다이렉트 커넥티드
- 라우팅 테이블을 확인해 목적지가 다이렉트 커넥티드라면 라우터는 L2통신(ARP요청)을 통해 목적지에 도달
- 목적지가 외부 테트워크인데 다이렉트 커넥티드 라우팅 테이블 정보만 있으면 외부 네트워크와 통신이 불가능
    - 외부 네트워크와 통신하려면 스태틱 라우팅이나 다이나믹 라우팅 테이블 정보가 필요

- 만약 다이렉트 커넥티드 정보를 잘못 입력하면 내, 외부 모두 네트워크 통신이 불가능하다
    - 외부 네트워크로 나가는 첫 번재 길목이 다이렉트 커넥티드이기 대문
    - IP주소를 잘못 설정하거나 서브넷 마스크를 정상범위보다 작거나 크게 설정하면 다이렉트 커넥티드 라우팅 정보가 잘못 입력되는데 이때 네트워크가 단절되는 상태가 발생한다

> ### [5.3.2] 스태틱 라우팅
- 스태틱 라우팅은 라우팅 테이블에 경로를 수동으로 추가해야 하는 프로세스
- 장점
    - 라우터 CPU에 라우팅 오버헤드가 없으므로 더 저렴한 라우터를 사용하여 라우팅을 수행할 수 있다
    - 관리자만 특정 네트워크로의 라우팅을 허용하므로 보안이 좋다
    - 라우터간에 대역폭 사용이 없다
- 단점
    - 대규모 네트워크의 경우 관리자가 각 라우터의 라우팅 테이블에서 라우팅 테이블에 경로를 수동으로 추가하는 것은 리소스가 많이 투입된다
    - 관리자가 토폴로지에 대해 잘 알고 있어야 한다
    - 새 관리자가 오면 문제가 발생할 수 있다

__디폴트 라우팅__
```
- 디폴트 라우팅은 스태틱 라우팅의 일종
- 
```
